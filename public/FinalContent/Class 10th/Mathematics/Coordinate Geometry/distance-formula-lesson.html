<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distance Formula and Its Applications</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .control-btn {
            background: rgba(126, 87, 194, 0.9);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            transform: scale(1.1);
            background: rgba(126, 87, 194, 1);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3.2rem;
            background: linear-gradient(45deg, #00ff88, #00bbff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Main Animation Stage */
        .animation-stage {
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 100%);
            border-radius: 25px;
            height: 600px;
            position: relative;
            margin: 40px 0;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            border: 4px solid rgba(0, 255, 136, 0.4);
        }

        /* Grid Background */
        .grid-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.3;
        }

        /* Content Container inside stage */
        .stage-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        /* Animation Scenes */
        .animation-scene {
            display: none;
            opacity: 0;
            transition: opacity 1s ease;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            padding: 40px;
        }

        .animation-scene.visible {
            display: flex;
            opacity: 1;
            align-items: center;
            justify-content: center;
        }

        /* Welcome Scene */
        .welcome-scene {
            text-align: center;
        }

        .welcome-title {
            font-size: 2.5rem;
            color: #00ff88;
            margin-bottom: 20px;
            animation: titleGlow 2s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 0 10px rgba(0, 255, 136, 0.5); }
            50% { text-shadow: 0 0 20px rgba(0, 255, 136, 0.8); }
        }

        /* Formula Display */
        .formula-box {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 187, 255, 0.1));
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            font-size: 1.8rem;
            font-family: 'Courier New', monospace;
            color: #00ff88;
            text-align: center;
            max-width: 600px;
        }

        .highlight {
            color: #ffff00;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        }

        /* Canvas for graphs */
        .graph-canvas {
            width: 100%;
            height: 100%;
        }

        /* Calculator Interface */
        .calculator-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            margin: 0 auto;
        }

        .input-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .input-group label {
            min-width: 120px;
            font-size: 1.1rem;
            color: #00ff88;
        }

        .input-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid rgba(0, 255, 136, 0.3);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
        }

        .calculate-btn {
            background: linear-gradient(135deg, #00ff88, #00bbff);
            border: none;
            color: #1a1a2e;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 255, 136, 0.4);
        }

        .result-display {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            text-align: center;
            font-size: 1.2rem;
            min-height: 60px;
        }

        /* Info Display */
        .info-display {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 15px 20px;
            text-align: center;
            font-size: 1.1rem;
            opacity: 0;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(10px);
            margin-top: 20px;
        }

        .info-display.visible {
            opacity: 1;
        }

        /* Controls */
        .controls {
            text-align: center;
            margin: 40px 0;
        }

        .controls-title {
            font-size: 2rem;
            margin-bottom: 25px;
            color: #00ff88;
            font-weight: 600;
        }

        .demo-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .demo-btn {
            background: linear-gradient(135deg, #764ba2, #667eea);
            border: none;
            color: white;
            padding: 16px 28px;
            border-radius: 35px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(118, 75, 162, 0.3);
            min-width: 180px;
        }

        .demo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(118, 75, 162, 0.4);
        }

        .demo-btn.active {
            background: linear-gradient(135deg, #00ff88, #00bbff);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        /* Analysis Panel */
        .analysis {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 25px;
            padding: 35px;
            margin: 35px 0;
            border: 3px solid rgba(0, 255, 136, 0.4);
            backdrop-filter: blur(15px);
        }

        .analysis-title {
            font-size: 1.6rem;
            color: #00ff88;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
        }

        .analysis-content {
            font-size: 1.2rem;
            line-height: 1.8;
            text-align: center;
            color: #e2e8f0;
        }

        /* Example Box */
        .example-box {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .example-title {
            font-size: 1.3rem;
            color: #ffd700;
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .animation-stage {
                height: 500px;
            }
            
            .demo-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">🔊</span>
            <span class="mute-icon">🔇</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Distance Formula</h1>
            <p>Master the distance formula and its applications in coordinate geometry!</p>
        </div>

        <!-- Main Animation Stage -->
        <div class="animation-stage" id="animation-stage">
            <div class="grid-background"></div>
            
            <!-- Stage Content Container -->
            <div class="stage-content">
                <!-- Welcome Scene -->
                <div class="animation-scene visible" id="welcome-scene">
                    <div class="welcome-scene">
                        <h2 class="welcome-title">Distance Formula & Applications</h2>
                        <p style="font-size: 1.3rem; color: #00bbff;">
                            Learn to calculate distances between points<br>
                            and solve real-world geometry problems!
                        </p>
                    </div>
                </div>

                <!-- Town Problem Scene -->
                <div class="animation-scene" id="town-scene">
                    <canvas id="town-canvas" class="graph-canvas"></canvas>
                </div>

                <!-- Formula Development Scene -->
                <div class="animation-scene" id="formula-scene">
                    <div style="width: 100%; max-width: 700px;">
                        <h2 style="font-size: 2rem; color: #00ff88; margin-bottom: 30px; text-align: center;">
                            The Distance Formula
                        </h2>
                        <div class="formula-box">
                            d = √[(x₂ - x₁)² + (y₂ - y₁)²]
                        </div>
                        <div style="text-align: center; margin-top: 30px;">
                            <p style="font-size: 1.2rem;">For any two points P(x₁, y₁) and Q(x₂, y₂)</p>
                            <p style="font-size: 1.1rem; color: #00bbff; margin-top: 10px;">
                                Based on the Pythagorean Theorem
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Basic Distance Scene -->
                <div class="animation-scene" id="basic-scene">
                    <canvas id="basic-canvas" class="graph-canvas"></canvas>
                </div>

                <!-- Calculator Scene -->
                <div class="animation-scene" id="calculator-scene">
                    <div class="calculator-container">
                        <h2 style="font-size: 1.8rem; color: #00ff88; margin-bottom: 20px; text-align: center;">
                            Distance Calculator
                        </h2>
                        <div class="input-group">
                            <label>Point 1 (x₁):</label>
                            <input type="number" id="x1-input" placeholder="Enter x₁">
                        </div>
                        <div class="input-group">
                            <label>Point 1 (y₁):</label>
                            <input type="number" id="y1-input" placeholder="Enter y₁">
                        </div>
                        <div class="input-group">
                            <label>Point 2 (x₂):</label>
                            <input type="number" id="x2-input" placeholder="Enter x₂">
                        </div>
                        <div class="input-group">
                            <label>Point 2 (y₂):</label>
                            <input type="number" id="y2-input" placeholder="Enter y₂">
                        </div>
                        <button class="calculate-btn" onclick="calculateDistance()">Calculate Distance</button>
                        <div class="result-display" id="calc-result">
                            Enter coordinates and click Calculate
                        </div>
                    </div>
                </div>

                <!-- Triangle Example Scene -->
                <div class="animation-scene" id="triangle-scene">
                    <canvas id="triangle-canvas" class="graph-canvas"></canvas>
                </div>

                <!-- Square Example Scene -->
                <div class="animation-scene" id="square-scene">
                    <canvas id="square-canvas" class="graph-canvas"></canvas>
                </div>

                <!-- Collinearity Scene -->
                <div class="animation-scene" id="collinear-scene">
                    <canvas id="collinear-canvas" class="graph-canvas"></canvas>
                </div>

                <!-- Equidistant Scene -->
                <div class="animation-scene" id="equidistant-scene">
                    <canvas id="equidistant-canvas" class="graph-canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Info Display -->
        <div class="info-display visible" id="info-display">
            Click any button below to start exploring the Distance Formula!
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-title" id="lesson-title">Choose Your Learning Path</div>
            
            <div class="demo-buttons">
                <button class="demo-btn" onclick="playCompleteLesson()">📚 Complete Lesson</button>
                <button class="demo-btn" onclick="showTownProblem()">🏘️ Town Problem</button>
                <button class="demo-btn" onclick="showFormula()">📐 Distance Formula</button>
                <button class="demo-btn" onclick="showBasicDistances()">📏 Basic Distances</button>
                <button class="demo-btn" onclick="showCalculator()">🧮 Calculator Tool</button>
                <button class="demo-btn" onclick="showTriangleExample()">📐 Triangle Example</button>
                <button class="demo-btn" onclick="showSquareExample()">⬜ Square Example</button>
                <button class="demo-btn" onclick="showCollinearity()">📍 Collinearity Check</button>
                <button class="demo-btn" onclick="showEquidistant()">⚖️ Equidistant Points</button>
                <button class="demo-btn" onclick="resetAll()">🔄 Reset</button>
            </div>
        </div>

        <!-- Analysis Panel -->
        <div class="analysis">
            <div class="analysis-title">📊 Understanding the Distance Formula</div>
            <div class="analysis-content" id="analysis-content">
                The distance formula helps us find the distance between any two points in a coordinate plane using the Pythagorean theorem.
                Select a demonstration above to begin exploring!
            </div>
        </div>
    </div>

    <script>
        // Voice System
        class DistanceNarrator {
            constructor() {
                this.isEnabled = globalAudioEnabled;
                this.currentUtterance = null;
                this.settings = { rate: 0.95, pitch: 1.0, volume: 0.85 };
                this.isDestroyed = false;
            }

            async speak(text, delay = 0) {
                if (!this.isEnabled || !text || this.isDestroyed) return;
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (this.isDestroyed) {
                            resolve();
                            return;
                        }
                        this.stop();
                        const utterance = new SpeechSynthesisUtterance(text);
                        Object.assign(utterance, this.settings);
                        
                        utterance.onend = resolve;
                        utterance.onerror = resolve;
                        
                        this.currentUtterance = utterance;
                        speechSynthesis.speak(utterance);
                    }, delay);
                });
            }

            stop() {
                speechSynthesis.cancel();
                this.currentUtterance = null;
            }

            destroy() {
                this.isDestroyed = true;
                this.stop();
                this.currentUtterance = null;
                this.settings = null;
            }
        }

        // Global state management
        let globalAudioEnabled = true;
        let currentNarrator = null;
        let isPlaying = false;
        let currentDemoAborted = false;
        let currentTaskId = null;
        let animationTimeouts = [];

        // Function to stop current demo
        function stopCurrentDemo() {
            currentDemoAborted = true;
            currentTaskId = null;
            
            // Stop and destroy narrator
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            
            // Stop speech synthesis completely
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            
            // Clear all timeouts
            animationTimeouts.forEach(timeout => clearTimeout(timeout));
            animationTimeouts = [];
            
            // Hide all animation scenes
            document.querySelectorAll('.animation-scene').forEach(scene => {
                scene.classList.remove('visible');
            });
            
            // Clear all canvases
            const canvases = ['town-canvas', 'basic-canvas', 'triangle-canvas', 'square-canvas', 
                            'collinear-canvas', 'equidistant-canvas'];
            canvases.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            });
            
            // Reset info display
            updateInfo("Click any button below to start exploring the Distance Formula!");
            
            // Reset flags
            isPlaying = false;
            currentDemoAborted = false;
            
            // Remove all active button states
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function shouldContinue(taskId = null) {
            if (taskId && currentTaskId && taskId !== currentTaskId) {
                return false;
            }
            return !currentDemoAborted;
        }

        function createNewNarrator(taskId = null) {
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            currentDemoAborted = false;
            currentTaskId = taskId;
            currentNarrator = new DistanceNarrator();
            return currentNarrator;
        }

        function switchToScene(sceneId, taskId = null) {
            if (!shouldContinue(taskId)) return;
            
            document.querySelectorAll('.animation-scene').forEach(scene => {
                scene.classList.remove('visible');
            });
            
            const timeout = setTimeout(() => {
                if (!shouldContinue(taskId)) return;
                const scene = document.getElementById(sceneId);
                if (scene) {
                    scene.classList.add('visible');
                }
            }, 300);
            
            animationTimeouts.push(timeout);
        }

        // Draw coordinate system
        function drawCoordinateSystem(canvasId, scale = 20) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = 500;
            
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 0.5;
            
            for (let x = 0; x < width; x += scale) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            for (let y = 0; y < height; y += scale) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 3;
            
            // X-axis
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Y-axis
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            // Draw arrows
            ctx.fillStyle = '#00ff88';
            
            // X-axis arrow
            ctx.beginPath();
            ctx.moveTo(width - 5, centerY);
            ctx.lineTo(width - 20, centerY - 8);
            ctx.lineTo(width - 20, centerY + 8);
            ctx.closePath();
            ctx.fill();
            
            // Y-axis arrow
            ctx.beginPath();
            ctx.moveTo(centerX, 5);
            ctx.lineTo(centerX - 8, 20);
            ctx.lineTo(centerX + 8, 20);
            ctx.closePath();
            ctx.fill();
            
            // Labels
            ctx.font = 'bold 18px Arial';
            ctx.fillStyle = '#00bbff';
            ctx.fillText('X', width - 30, centerY - 10);
            ctx.fillText('Y', centerX + 12, 25);
            
            ctx.font = 'bold 14px Arial';
            ctx.fillStyle = '#ffff00';
            ctx.fillText('O', centerX - 18, centerY + 20);
            
            return { ctx, centerX, centerY, scale };
        }

        // Plot a point
        function plotPoint(ctx, centerX, centerY, scale, x, y, label, color) {
            const canvasX = centerX + x * scale;
            const canvasY = centerY - y * scale;
            
            // Draw point
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(canvasX, canvasY, 5, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw label
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 13px Arial';
            ctx.fillText(label, canvasX + 8, canvasY - 8);
            
            // Show coordinates
            ctx.font = '11px Arial';
            ctx.fillStyle = color;
            ctx.fillText(`(${x}, ${y})`, canvasX + 8, canvasY + 18);
        }

        // Draw line between points
        function drawLine(ctx, centerX, centerY, scale, x1, y1, x2, y2, color, dashed = false) {
            const canvasX1 = centerX + x1 * scale;
            const canvasY1 = centerY - y1 * scale;
            const canvasX2 = centerX + x2 * scale;
            const canvasY2 = centerY - y2 * scale;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            
            if (dashed) {
                ctx.setLineDash([5, 5]);
            }
            
            ctx.beginPath();
            ctx.moveTo(canvasX1, canvasY1);
            ctx.lineTo(canvasX2, canvasY2);
            ctx.stroke();
            
            ctx.setLineDash([]);
        }

        // Calculate distance
        function calculateDistanceBetween(x1, y1, x2, y2) {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        // Initialize
        window.addEventListener('load', () => {
            document.getElementById('welcome-scene').classList.add('visible');
            const narrator = createNewNarrator('initialization');
            narrator.speak("Welcome to the Distance Formula lesson! Let's learn how to calculate distances between points.");
            updateInfo("Click any button below to start exploring the Distance Formula!");
        });

        // Complete Lesson
        async function playCompleteLesson() {
            const taskId = 'complete-lesson';
            stopCurrentDemo();
            await wait(100);
            isPlaying = true;
            setActiveButton(0);
            
            const narrator = createNewNarrator(taskId);
            
            updateTitle("📚 Complete Distance Formula Journey");
            updateInfo("Starting complete lesson - exploring all concepts...");
            updateAnalysis("Beginning our comprehensive journey through the distance formula...");
            
            await narrator.speak("Welcome to the complete lesson on the distance formula!");
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            
            // Part 1: Town problem
            await showTownProblemDemo(narrator, taskId);
            if (!shouldContinue(taskId)) return;
            await wait(2000);
            
            // Part 2: Formula
            await showFormulaDemo(narrator, taskId);
            if (!shouldContinue(taskId)) return;
            await wait(2000);
            
            // Part 3: Basic distances
            await showBasicDistancesDemo(narrator, taskId);
            if (!shouldContinue(taskId)) return;
            await wait(2000);
            
            // Part 4: Triangle example with full calculation
            await showTriangleExampleDemo(narrator, taskId);
            if (!shouldContinue(taskId)) return;
            await wait(2000);
            
            // Part 5: Square example with full calculation
            await showSquareExampleDemo(narrator, taskId);
            if (!shouldContinue(taskId)) return;
            await wait(2000);
            
            // Part 6: Collinearity check
            await showCollinearityDemo(narrator, taskId);
            if (!shouldContinue(taskId)) return;
            await wait(2000);
            
            // Part 7: Equidistant points
            await showEquidistantDemo(narrator, taskId);
            if (!shouldContinue(taskId)) return;
            
            updateInfo("Lesson Complete! You've mastered the distance formula and all its applications!");
            await narrator.speak("Congratulations! You now understand the distance formula and can apply it to various geometric problems!");
            
            updateAnalysis("Complete lesson finished! You've learned: 1) The distance formula derivation, 2) Basic distance calculations, 3) Triangle type identification, 4) Square verification, 5) Collinearity checking, and 6) Finding equidistant points.");
            
            isPlaying = false;
        }

        // Town Problem
        async function showTownProblem() {
            const taskId = 'town-problem';
            stopCurrentDemo();
            await wait(100);
            isPlaying = true;
            setActiveButton(1);
            
            const narrator = createNewNarrator(taskId);
            await showTownProblemDemo(narrator, taskId);
            
            isPlaying = false;
        }

        async function showTownProblemDemo(narrator, taskId) {
            updateTitle("🏘️ The Town Problem");
            switchToScene('town-scene', taskId);
            updateInfo("Town B is 36 km east and 15 km north of Town A");
            
            await wait(500);
            if (!shouldContinue(taskId)) return;
            
            const result = drawCoordinateSystem('town-canvas', 3);
            if (!result) return;
            
            const { ctx, centerX, centerY, scale } = result;
            
            // Plot Town A at origin
            plotPoint(ctx, centerX, centerY, scale, 0, 0, 'Town A', '#ffff00');
            
            await narrator.speak("Town A is at the origin. Town B is 36 kilometers east and 15 kilometers north.");
            await wait(2000);
            
            // Plot Town B
            plotPoint(ctx, centerX, centerY, scale, 36, 15, 'Town B', '#00bbff');
            
            // Draw the direct distance
            drawLine(ctx, centerX, centerY, scale, 0, 0, 36, 15, '#ff69b4');
            
            // Draw the right triangle
            drawLine(ctx, centerX, centerY, scale, 0, 0, 36, 0, '#00ff88', true);
            drawLine(ctx, centerX, centerY, scale, 36, 0, 36, 15, '#00ff88', true);
            
            await narrator.speak("Using the Pythagorean theorem, we can calculate the distance.");
            await wait(2000);
            
            const distance = calculateDistanceBetween(0, 0, 36, 15);
            updateInfo(`Distance = √(36² + 15²) = √(1296 + 225) = √1521 = ${distance} km`);
            
            await narrator.speak(`The distance is the square root of 36 squared plus 15 squared, which equals 39 kilometers.`);
            
            updateAnalysis("The town problem demonstrates how the distance formula comes from the Pythagorean theorem. When we know the horizontal and vertical distances, we can find the direct distance.");
        }

        // Show Formula
        async function showFormula() {
            const taskId = 'show-formula';
            stopCurrentDemo();
            await wait(100);
            isPlaying = true;
            setActiveButton(2);
            
            const narrator = createNewNarrator(taskId);
            await showFormulaDemo(narrator, taskId);
            
            isPlaying = false;
        }

        async function showFormulaDemo(narrator, taskId) {
            updateTitle("📐 The Distance Formula");
            switchToScene('formula-scene', taskId);
            updateInfo("Deriving the general distance formula");
            
            await narrator.speak("The distance formula for any two points P and Q is d equals the square root of x2 minus x1 squared plus y2 minus y1 squared.");
            await wait(3000);
            
            updateInfo("This formula works for any two points in the coordinate plane!");
            
            updateAnalysis("The distance formula d = √[(x₂ - x₁)² + (y₂ - y₁)²] is derived from the Pythagorean theorem and works for any two points in the coordinate plane.");
        }

        // Show Basic Distances
        async function showBasicDistances() {
            const taskId = 'basic-distances';
            stopCurrentDemo();
            await wait(100);
            isPlaying = true;
            setActiveButton(3);
            
            const narrator = createNewNarrator(taskId);
            await showBasicDistancesDemo(narrator, taskId);
            
            isPlaying = false;
        }

        async function showBasicDistancesDemo(narrator, taskId) {
            updateTitle("📏 Basic Distance Calculations");
            switchToScene('basic-scene', taskId);
            updateInfo("Calculating distances on axes");
            
            await wait(500);
            if (!shouldContinue(taskId)) return;
            
            const result = drawCoordinateSystem('basic-canvas');
            if (!result) return;
            
            const { ctx, centerX, centerY, scale } = result;
            
            // Points on x-axis
            plotPoint(ctx, centerX, centerY, scale, 4, 0, 'A', '#ffff00');
            plotPoint(ctx, centerX, centerY, scale, 6, 0, 'B', '#ffff00');
            drawLine(ctx, centerX, centerY, scale, 4, 0, 6, 0, '#ffff00');
            
            await narrator.speak("Points on the x-axis: A at 4, 0 and B at 6, 0. Distance is simply 6 minus 4 equals 2 units.");
            await wait(3000);
            
            // Points on y-axis
            plotPoint(ctx, centerX, centerY, scale, 0, 3, 'C', '#00bbff');
            plotPoint(ctx, centerX, centerY, scale, 0, 8, 'D', '#00bbff');
            drawLine(ctx, centerX, centerY, scale, 0, 3, 0, 8, '#00bbff');
            
            await narrator.speak("Points on the y-axis: C at 0, 3 and D at 0, 8. Distance is 8 minus 3 equals 5 units.");
            
            updateAnalysis("When points lie on the same axis, the distance calculation is simplified to a simple subtraction.");
        }

        // Calculator
        async function showCalculator() {
            const taskId = 'calculator';
            stopCurrentDemo();
            await wait(100);
            isPlaying = true;
            setActiveButton(4);
            
            const narrator = createNewNarrator(taskId);
            
            updateTitle("🧮 Distance Calculator Tool");
            switchToScene('calculator-scene', taskId);
            updateInfo("Calculate the distance between any two points");
            
            await narrator.speak("Use this calculator to find the distance between any two points. Enter the coordinates and click Calculate.");
            
            updateAnalysis("The calculator uses the distance formula d = √[(x₂ - x₁)² + (y₂ - y₁)²] to compute the exact distance between any two points.");
            
            isPlaying = false;
        }

        function calculateDistance() {
            const x1 = parseFloat(document.getElementById('x1-input').value);
            const y1 = parseFloat(document.getElementById('y1-input').value);
            const x2 = parseFloat(document.getElementById('x2-input').value);
            const y2 = parseFloat(document.getElementById('y2-input').value);
            
            if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) {
                document.getElementById('calc-result').innerHTML = 
                    '<span style="color: #ff6b6b;">Please enter all coordinates</span>';
                return;
            }
            
            const distance = calculateDistanceBetween(x1, y1, x2, y2);
            
            document.getElementById('calc-result').innerHTML = 
                `<span style="color: #00ff88;">Distance = ${distance.toFixed(2)} units</span><br>
                <span style="font-size: 0.9rem;">d = √[(${x2} - ${x1})² + (${y2} - ${y1})²]</span>`;
        }

        // Triangle Example
        async function showTriangleExample() {
            const taskId = 'triangle-example';
            stopCurrentDemo();
            await wait(100);
            isPlaying = true;
            setActiveButton(5);
            
            const narrator = createNewNarrator(taskId);
            await showTriangleExampleDemo(narrator, taskId);
            
            isPlaying = false;
        }

        async function showTriangleExampleDemo(narrator, taskId) {
            updateTitle("📐 Triangle Type Identifier");
            switchToScene('triangle-scene', taskId);
            updateInfo("Example: Points P(3, 2), Q(-2, -3), and R(2, 3)");
            
            await wait(500);
            if (!shouldContinue(taskId)) return;
            
            const result = drawCoordinateSystem('triangle-canvas');
            if (!result) return;
            
            const { ctx, centerX, centerY, scale } = result;
            
            // Plot triangle vertices
            const points = [[3, 2], [-2, -3], [2, 3]];
            const labels = ['P', 'Q', 'R'];
            const colors = ['#ffff00', '#00bbff', '#ff69b4'];
            
            for (let i = 0; i < points.length; i++) {
                plotPoint(ctx, centerX, centerY, scale, points[i][0], points[i][1], labels[i], colors[i]);
            }
            
            await narrator.speak("Let's check if points P at 3, 2, Q at negative 2, negative 3, and R at 2, 3 form a triangle.");
            await wait(2000);
            
            // Draw triangle sides
            drawLine(ctx, centerX, centerY, scale, 3, 2, -2, -3, '#00ff88');
            drawLine(ctx, centerX, centerY, scale, -2, -3, 2, 3, '#00ff88');
            drawLine(ctx, centerX, centerY, scale, 2, 3, 3, 2, '#00ff88');
            
            await wait(1000);
            
            // Calculate PQ
            updateInfo("Step 1: Calculate PQ = √[(3-(-2))² + (2-(-3))²]");
            await narrator.speak("First, let's calculate PQ. The x difference is 3 minus negative 2, which equals 5.");
            await wait(2000);
            
            updateInfo("PQ = √[5² + 5²] = √[25 + 25] = √50 = 7.07 units");
            await narrator.speak("The y difference is 2 minus negative 3, which equals 5. So PQ equals square root of 50, or 7.07 units.");
            await wait(3000);
            
            // Calculate QR
            updateInfo("Step 2: Calculate QR = √[(-2-2)² + (-3-3)²]");
            await narrator.speak("Now calculate QR. The x difference is negative 2 minus 2, which equals negative 4.");
            await wait(2000);
            
            updateInfo("QR = √[(-4)² + (-6)²] = √[16 + 36] = √52 = 7.21 units");
            await narrator.speak("The y difference is negative 3 minus 3, which equals negative 6. So QR equals square root of 52, or 7.21 units.");
            await wait(3000);
            
            // Calculate PR
            updateInfo("Step 3: Calculate PR = √[(3-2)² + (2-3)²]");
            await narrator.speak("Finally, calculate PR. The x difference is 3 minus 2, which equals 1.");
            await wait(2000);
            
            updateInfo("PR = √[1² + (-1)²] = √[1 + 1] = √2 = 1.41 units");
            await narrator.speak("The y difference is 2 minus 3, which equals negative 1. So PR equals square root of 2, or 1.41 units.");
            await wait(3000);
            
            // Check triangle inequality
            updateInfo("Checking: PQ + PR = 7.07 + 1.41 = 8.48 > QR = 7.21 ✓");
            await narrator.speak("The sum of any two sides is greater than the third side, so these points do form a triangle.");
            await wait(3000);
            
            // Check for right triangle
            updateInfo("Checking right angle: PQ² + PR² = 50 + 2 = 52 = QR² ✓");
            await narrator.speak("Since PQ squared plus PR squared equals QR squared, this is a right triangle with the right angle at P!");
            await wait(2000);
            
            // Mark the right angle
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            const rightAngleSize = 15;
            const pX = centerX + 3 * scale;
            const pY = centerY - 2 * scale;
            ctx.moveTo(pX - rightAngleSize, pY);
            ctx.lineTo(pX - rightAngleSize, pY + rightAngleSize);
            ctx.lineTo(pX, pY + rightAngleSize);
            ctx.stroke();
            
            updateAnalysis("Triangle verification complete! PQ = 7.07, QR = 7.21, PR = 1.41. Since PQ² + PR² = QR² (50 + 2 = 52), triangle PQR is a right triangle with ∠P = 90°.");
        }

        // Square Example
        async function showSquareExample() {
            const taskId = 'square-example';
            stopCurrentDemo();
            await wait(100);
            isPlaying = true;
            setActiveButton(6);
            
            const narrator = createNewNarrator(taskId);
            await showSquareExampleDemo(narrator, taskId);
            
            isPlaying = false;
        }

        async function showSquareExampleDemo(narrator, taskId) {
            updateTitle("⬜ Square Verification");
            switchToScene('square-scene', taskId);
            updateInfo("Example: Points A(1, 7), B(4, 2), C(-1, -1), and D(-4, 4)");
            
            await wait(500);
            if (!shouldContinue(taskId)) return;
            
            const result = drawCoordinateSystem('square-canvas');
            if (!result) return;
            
            const { ctx, centerX, centerY, scale } = result;
            
            // Plot square vertices
            const points = [[1, 7], [4, 2], [-1, -1], [-4, 4]];
            const labels = ['A', 'B', 'C', 'D'];
            const colors = ['#ffff00', '#00bbff', '#ff69b4', '#00ff88'];
            
            for (let i = 0; i < points.length; i++) {
                plotPoint(ctx, centerX, centerY, scale, points[i][0], points[i][1], labels[i], colors[i]);
            }
            
            await narrator.speak("To verify these points form a square, we need to check that all four sides are equal and both diagonals are equal.");
            await wait(3000);
            
            // Draw and calculate side AB
            drawLine(ctx, centerX, centerY, scale, 1, 7, 4, 2, '#00ff88');
            updateInfo("Side AB = √[(1-4)² + (7-2)²] = √[(-3)² + 5²]");
            await wait(2000);
            
            updateInfo("AB = √[9 + 25] = √34 = 5.83 units");
            await narrator.speak("Side AB equals square root of 34, which is 5.83 units.");
            await wait(2500);
            
            // Draw and calculate side BC
            drawLine(ctx, centerX, centerY, scale, 4, 2, -1, -1, '#00ff88');
            updateInfo("Side BC = √[(4-(-1))² + (2-(-1))²] = √[5² + 3²]");
            await wait(2000);
            
            updateInfo("BC = √[25 + 9] = √34 = 5.83 units");
            await narrator.speak("Side BC also equals square root of 34.");
            await wait(2500);
            
            // Draw and calculate side CD
            drawLine(ctx, centerX, centerY, scale, -1, -1, -4, 4, '#00ff88');
            updateInfo("Side CD = √[(-1-(-4))² + (-1-4)²] = √[3² + (-5)²]");
            await wait(2000);
            
            updateInfo("CD = √[9 + 25] = √34 = 5.83 units");
            await narrator.speak("Side CD equals square root of 34.");
            await wait(2500);
            
            // Draw and calculate side DA
            drawLine(ctx, centerX, centerY, scale, -4, 4, 1, 7, '#00ff88');
            updateInfo("Side DA = √[(1-(-4))² + (7-4)²] = √[5² + 3²]");
            await wait(2000);
            
            updateInfo("DA = √[25 + 9] = √34 = 5.83 units");
            await narrator.speak("Side DA also equals square root of 34. All four sides are equal!");
            await wait(3000);
            
            // Draw and calculate diagonal AC
            drawLine(ctx, centerX, centerY, scale, 1, 7, -1, -1, '#ffff00', true);
            updateInfo("Diagonal AC = √[(1-(-1))² + (7-(-1))²] = √[2² + 8²]");
            await wait(2000);
            
            updateInfo("AC = √[4 + 64] = √68 = 8.25 units");
            await narrator.speak("Diagonal AC equals square root of 68, which is 8.25 units.");
            await wait(2500);
            
            // Draw and calculate diagonal BD
            drawLine(ctx, centerX, centerY, scale, 4, 2, -4, 4, '#ffff00', true);
            updateInfo("Diagonal BD = √[(4-(-4))² + (2-4)²] = √[8² + (-2)²]");
            await wait(2000);
            
            updateInfo("BD = √[64 + 4] = √68 = 8.25 units");
            await narrator.speak("Diagonal BD also equals square root of 68. Both diagonals are equal!");
            await wait(2500);
            
            // Verify right angle
            updateInfo("Checking right angle: AD² + DC² = 34 + 34 = 68 = AC²");
            await narrator.speak("We can also verify that angle D is 90 degrees using the Pythagorean theorem.");
            await wait(2500);
            
            updateInfo("✓ All sides equal (√34) and both diagonals equal (√68) → ABCD is a SQUARE!");
            await narrator.speak("Since all four sides are equal, both diagonals are equal, and we have a right angle, ABCD is definitely a square!");
            
            updateAnalysis("Square verification complete! All four sides = √34 = 5.83 units. Both diagonals = √68 = 8.25 units. Also verified: AD² + DC² = AC² (34 + 34 = 68), confirming ∠D = 90°. Therefore, ABCD is a square.");
        }

        // Collinearity Check
        async function showCollinearity() {
            const taskId = 'collinearity';
            stopCurrentDemo();
            await wait(100);
            isPlaying = true;
            setActiveButton(7);
            
            const narrator = createNewNarrator(taskId);
            await showCollinearityDemo(narrator, taskId);
            
            isPlaying = false;
        }

        async function showCollinearityDemo(narrator, taskId) {
            updateTitle("📍 Collinearity Check");
            switchToScene('collinear-scene', taskId);
            updateInfo("Example: Ashima (3, 1), Bharti (6, 4), and Camella (8, 6)");
            
            await wait(500);
            if (!shouldContinue(taskId)) return;
            
            const result = drawCoordinateSystem('collinear-canvas');
            if (!result) return;
            
            const { ctx, centerX, centerY, scale } = result;
            
            // Plot points
            plotPoint(ctx, centerX, centerY, scale, 3, 1, 'Ashima', '#ffff00');
            plotPoint(ctx, centerX, centerY, scale, 6, 4, 'Bharti', '#00bbff');
            plotPoint(ctx, centerX, centerY, scale, 8, 6, 'Camella', '#ff69b4');
            
            await narrator.speak("Three points are collinear if they lie on the same line. Let's check using the distance formula.");
            await wait(2500);
            
            // Calculate AB
            updateInfo("Calculate AB = √[(6-3)² + (4-1)²] = √[9 + 9] = √18 = 3√2");
            await narrator.speak("Distance AB equals square root of 18, which is 3 root 2.");
            await wait(2500);
            
            // Calculate BC
            updateInfo("Calculate BC = √[(8-6)² + (6-4)²] = √[4 + 4] = √8 = 2√2");
            await narrator.speak("Distance BC equals square root of 8, which is 2 root 2.");
            await wait(2500);
            
            // Calculate AC
            updateInfo("Calculate AC = √[(8-3)² + (6-1)²] = √[25 + 25] = √50 = 5√2");
            await narrator.speak("Distance AC equals square root of 50, which is 5 root 2.");
            await wait(2500);
            
            // Check collinearity
            updateInfo("Checking: AB + BC = 3√2 + 2√2 = 5√2 = AC ✓");
            await narrator.speak("Since AB plus BC equals AC (3 root 2 plus 2 root 2 equals 5 root 2), the points are collinear!");
            await wait(2000);
            
            // Draw line through all points
            drawLine(ctx, centerX, centerY, scale, 3, 1, 8, 6, '#00ff88', false);
            
            updateInfo("They are seated in a line!");
            
            updateAnalysis("Collinearity verified! AB + BC = AC (3√2 + 2√2 = 5√2). When the sum of two distances equals the third distance, all three points lie on the same straight line.");
        }

        // Equidistant Points
        async function showEquidistant() {
            const taskId = 'equidistant';
            stopCurrentDemo();
            await wait(100);
            isPlaying = true;
            setActiveButton(8);
            
            const narrator = createNewNarrator(taskId);
            await showEquidistantDemo(narrator, taskId);
            
            isPlaying = false;
        }

        async function showEquidistantDemo(narrator, taskId) {
            updateTitle("⚖️ Equidistant Points");
            switchToScene('equidistant-scene', taskId);
            updateInfo("Find a point on y-axis equidistant from A(6, 5) and B(-4, 3)");
            
            await wait(500);
            if (!shouldContinue(taskId)) return;
            
            const result = drawCoordinateSystem('equidistant-canvas');
            if (!result) return;
            
            const { ctx, centerX, centerY, scale } = result;
            
            // Plot given points
            plotPoint(ctx, centerX, centerY, scale, 6, 5, 'A', '#ffff00');
            plotPoint(ctx, centerX, centerY, scale, -4, 3, 'B', '#00bbff');
            
            await narrator.speak("We need to find a point on the y-axis that is the same distance from both A and B.");
            await wait(2500);
            
            updateInfo("Let P(0, y) be the point on y-axis. We need PA = PB");
            await narrator.speak("Let's call the point P with coordinates 0, y since it's on the y-axis.");
            await wait(2500);
            
            updateInfo("Setting PA² = PB²: (6-0)² + (5-y)² = (-4-0)² + (3-y)²");
            await narrator.speak("Setting the distances equal: PA squared equals PB squared.");
            await wait(2500);
            
            updateInfo("36 + 25 - 10y + y² = 16 + 9 - 6y + y²");
            await wait(2000);
            
            updateInfo("61 - 10y = 25 - 6y → 36 = 4y → y = 9");
            await narrator.speak("Solving the equation, we get y equals 9.");
            await wait(2500);
            
            // Plot solution point
            plotPoint(ctx, centerX, centerY, scale, 0, 9, 'P', '#00ff88');
            
            // Draw distances
            drawLine(ctx, centerX, centerY, scale, 0, 9, 6, 5, '#ff69b4', true);
            drawLine(ctx, centerX, centerY, scale, 0, 9, -4, 3, '#ff69b4', true);
            
            // Verify distances
            const distPA = calculateDistanceBetween(0, 9, 6, 5);
            const distPB = calculateDistanceBetween(0, 9, -4, 3);
            
            updateInfo(`Verification: PA = √52 = ${distPA.toFixed(2)}, PB = √52 = ${distPB.toFixed(2)} ✓`);
            await narrator.speak("Let's verify: PA equals PB equals square root of 52. The point (0, 9) is equidistant from both A and B!");
            
            updateAnalysis("Solution found! Point P(0, 9) on the y-axis is equidistant from A(6, 5) and B(-4, 3). Both distances equal √52 ≈ 7.21 units. This point lies on the perpendicular bisector of segment AB.");
        }

        // Reset
        async function resetAll() {
            stopCurrentDemo();
            
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            
            animationTimeouts.forEach(timeout => clearTimeout(timeout));
            animationTimeouts = [];
            
            document.querySelectorAll('.animation-scene').forEach(scene => {
                scene.classList.remove('visible');
            });
            
            const canvases = ['town-canvas', 'basic-canvas', 'triangle-canvas', 'square-canvas', 
                            'collinear-canvas', 'equidistant-canvas'];
            canvases.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    canvas.width = canvas.width;
                }
            });
            
            // Clear calculator inputs
            document.getElementById('x1-input').value = '';
            document.getElementById('y1-input').value = '';
            document.getElementById('x2-input').value = '';
            document.getElementById('y2-input').value = '';
            document.getElementById('calc-result').textContent = 'Enter coordinates and click Calculate';
            
            await wait(100);
            
            document.getElementById('welcome-scene').classList.add('visible');
            
            updateTitle("Choose Your Learning Path");
            updateInfo("Click any button below to start exploring the Distance Formula!");
            updateAnalysis("The distance formula helps us find the distance between any two points in a coordinate plane using the Pythagorean theorem. Select a demonstration above to begin exploring!");
            
            setActiveButton(-1);
            
            isPlaying = false;
            currentDemoAborted = false;
            currentTaskId = null;
            
            await wait(50);
        }

        // Helper functions
        function updateTitle(title) {
            document.getElementById('lesson-title').textContent = title;
        }

        function updateInfo(text) {
            const info = document.getElementById('info-display');
            info.textContent = text;
            info.classList.add('visible');
        }

        function updateAnalysis(text) {
            document.getElementById('analysis-content').textContent = text;
        }

        function setActiveButton(index) {
            document.querySelectorAll('.demo-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
        }

        function wait(ms) {
            return new Promise(resolve => {
                const timeout = setTimeout(resolve, ms);
                animationTimeouts.push(timeout);
            });
        }

        // Audio Control
        document.getElementById('mute-btn').addEventListener('click', () => {
            globalAudioEnabled = !globalAudioEnabled;
            if (currentNarrator) {
                currentNarrator.isEnabled = globalAudioEnabled;
                if (!globalAudioEnabled) {
                    currentNarrator.stop();
                }
            }
            document.getElementById('mute-btn').classList.toggle('muted', !globalAudioEnabled);
        });
    </script>
</body>
</html>