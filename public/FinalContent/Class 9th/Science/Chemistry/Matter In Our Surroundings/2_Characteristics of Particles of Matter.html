<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Characteristics of Particles of Matter - Interactive Chemistry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #764ba2 75%, #667eea 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background Particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(3px 3px at 20% 30%, rgba(255,255,255,0.4), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(255,255,255,0.3), transparent),
                radial-gradient(1px 1px at 90% 40%, rgba(255,255,255,0.2), transparent);
            background-size: 400px 400px;
            opacity: 0.6;
            animation: particleFloat 120s linear infinite;
            pointer-events: none;
        }

        @keyframes particleFloat {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(-400px, -400px) rotate(360deg); }
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .control-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 3.5rem;
            background: linear-gradient(45deg, #f093fb, #f5576c, #4facfe, #00f2fe);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
            animation: glow 4s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { 
                filter: brightness(1) drop-shadow(0 0 20px rgba(240, 147, 251, 0.5)); 
            }
            50% { 
                filter: brightness(1.3) drop-shadow(0 0 40px rgba(79, 172, 254, 0.7)); 
            }
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Science Stage */
        .science-stage {
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.9) 0%,
                rgba(118, 75, 162, 0.9) 50%,
                rgba(102, 126, 234, 0.9) 100%);
            border-radius: 25px;
            height: 600px;
            position: relative;
            margin: 40px 0;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 0 120px rgba(240, 147, 251, 0.2);
            overflow: hidden;
            border: 3px solid rgba(240, 147, 251, 0.4);
        }

        #particleCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #particleCanvas:active {
            cursor: grabbing;
        }

        /* Stage Info Overlay */
        .stage-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 2px solid rgba(240, 147, 251, 0.4);
            max-width: 320px;
        }

        .stage-info h3 {
            font-size: 1.3rem;
            color: #f093fb;
            margin-bottom: 8px;
        }

        .stage-info p {
            font-size: 0.95rem;
            color: #e2e8f0;
            line-height: 1.5;
        }

        /* Temperature Control */
        .temperature-control {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(240, 147, 251, 0.4);
        }

        .temp-label {
            color: #f093fb;
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-align: center;
        }

        .temp-slider {
            width: 150px;
            margin: 10px 0;
        }

        .temp-value {
            color: #00f2fe;
            font-weight: bold;
            text-align: center;
            font-size: 1.1rem;
        }

        /* Control Panel */
        .controls {
            text-align: center;
            margin: 40px 0;
        }

        .controls-title {
            font-size: 2rem;
            margin-bottom: 25px;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
        }

        .demo-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .demo-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 16px 28px;
            border-radius: 35px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            min-width: 180px;
            position: relative;
            overflow: hidden;
        }

        .demo-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .demo-btn:hover::before {
            left: 100%;
        }

        .demo-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
        }

        .demo-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            }
            50% { 
                box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
            }
        }

        /* Analysis Panel */
        .analysis {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.7),
                rgba(102, 126, 234, 0.7));
            border-radius: 25px;
            padding: 35px;
            margin: 35px 0;
            border: 3px solid rgba(240, 147, 251, 0.4);
            backdrop-filter: blur(15px);
        }

        .analysis-title {
            font-size: 1.8rem;
            background: linear-gradient(45deg, #f093fb, #4facfe);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
        }

        /* Characteristics Grid */
        .characteristics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .characteristic-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .characteristic-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .characteristic-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .characteristic-title {
            font-size: 1.1rem;
            color: #f093fb;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .characteristic-description {
            font-size: 0.9rem;
            color: #cbd5e1;
            line-height: 1.4;
        }

        /* Progress Indicator */
        .progress-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: linear-gradient(135deg, #f093fb, #4facfe);
            transform: scale(1.3);
        }

        .progress-dot.completed {
            background: #10b981;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(240, 147, 251, 0.4);
        }

        .legend-title {
            font-size: 1rem;
            color: #f093fb;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .legend-items {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .legend-label {
            font-size: 0.9rem;
            color: #e2e8f0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .science-stage {
                height: 400px;
            }
            
            .demo-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .characteristics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">🔊</span>
            <span class="mute-icon">🔇</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Characteristics of Particles of Matter</h1>
            <p>Discover the three fundamental properties that define all matter: spaces between particles, continuous motion, and attractive forces!</p>
        </div>

        <!-- Science Stage -->
        <div class="science-stage" id="stage">
            <canvas id="particleCanvas"></canvas>
            
            <div class="stage-info" id="stageInfo">
                <h3 id="infoTitle">Particle Properties</h3>
                <p id="infoText">Select an activity to explore particle characteristics</p>
            </div>
            
            <div class="temperature-control">
                <div class="temp-label">Temperature</div>
                <input type="range" id="tempSlider" class="temp-slider" min="0" max="100" value="25">
                <div class="temp-value" id="tempValue">25°C</div>
            </div>
            
            <div class="legend">
                <div class="legend-title">Particle Types</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4facfe;"></div>
                        <span class="legend-label">Water</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f5576c;"></div>
                        <span class="legend-label">Solute</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9d4edd;"></div>
                        <span class="legend-label">Fragrance</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-title" id="lesson-title">Explore Particle Characteristics</div>
            
            <div class="demo-buttons">
                <button class="demo-btn" id="btn-complete" onclick="playCompleteLesson()">📚 Complete Lesson</button>
                <button class="demo-btn" id="btn-spaces" onclick="showSpacesBetween()">🌌 Spaces Between</button>
                <button class="demo-btn" id="btn-movement" onclick="showContinuousMovement()">🔥 Continuous Motion</button>
                <button class="demo-btn" id="btn-forces" onclick="showAttractionForces()">🧲 Attractive Forces</button>
                <button class="demo-btn" id="btn-diffusion" onclick="showDiffusion()">💨 Diffusion Demo</button>
                <button class="demo-btn" id="btn-activity13" onclick="showActivity13()">🔬 Activity 1.3</button>
                <button class="demo-btn" id="btn-activity14" onclick="showActivity14()">🧪 Activity 1.4</button>
                <button class="demo-btn" id="btn-activity15" onclick="showActivity15()">🌡️ Activity 1.5</button>
                <button class="demo-btn" id="btn-activity16" onclick="showActivity16()">💥 Activity 1.6</button>
                <button class="demo-btn" id="btn-activity17" onclick="showActivity17()">🔨 Activity 1.7</button>
                <button class="demo-btn" id="btn-activity18" onclick="showActivity18()">💧 Activity 1.8</button>
                <button class="demo-btn" id="btn-reset" onclick="resetAllClick()">🔄 Reset</button>
            </div>
        </div>

        <!-- Analysis Panel -->
        <div class="analysis">
            <div class="analysis-title">🔬 Understanding Particle Characteristics</div>
            
            <div class="characteristics-grid">
                <div class="characteristic-card">
                    <div class="characteristic-icon">🌌</div>
                    <div class="characteristic-title">Spaces Between Particles</div>
                    <div class="characteristic-description">All matter has empty spaces between particles where other particles can fit</div>
                </div>
                <div class="characteristic-card">
                    <div class="characteristic-icon">🔥</div>
                    <div class="characteristic-title">Continuous Movement</div>
                    <div class="characteristic-description">Particles are always moving due to their kinetic energy</div>
                </div>
                <div class="characteristic-card">
                    <div class="characteristic-icon">🧲</div>
                    <div class="characteristic-title">Attractive Forces</div>
                    <div class="characteristic-description">Particles attract each other with varying force strengths</div>
                </div>
            </div>

            <div id="current-analysis" style="text-align: center; margin-top: 20px; font-size: 1.1rem; color: #e2e8f0; line-height: 1.6;">
                Matter particles have three key characteristics that explain all physical phenomena around us!
            </div>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-indicator" id="progressIndicator" style="display: none;">
        <div class="progress-dot" data-step="1"></div>
        <div class="progress-dot" data-step="2"></div>
        <div class="progress-dot" data-step="3"></div>
        <div class="progress-dot" data-step="4"></div>
        <div class="progress-dot" data-step="5"></div>
    </div>

    <script>
        // Voice System with Proper Cleanup
        class ParticleNarrator {
            constructor() {
                this.isEnabled = globalAudioEnabled;
                this.currentUtterance = null;
                this.settings = { rate: 0.9, pitch: 1.0, volume: 0.85 };
                this.isDestroyed = false;
            }

            async speak(text, delay = 0) {
                if (!this.isEnabled || !text || this.isDestroyed) return;
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (this.isDestroyed) {
                            resolve();
                            return;
                        }
                        this.stop();
                        const utterance = new SpeechSynthesisUtterance(text);
                        Object.assign(utterance, this.settings);
                        
                        utterance.onend = resolve;
                        utterance.onerror = resolve;
                        
                        this.currentUtterance = utterance;
                        speechSynthesis.speak(utterance);
                    }, delay);
                });
            }

            stop() {
                speechSynthesis.cancel();
                this.currentUtterance = null;
            }

            destroy() {
                this.isDestroyed = true;
                this.stop();
                this.currentUtterance = null;
                this.settings = null;
            }
        }

        // Global State Management
        let globalAudioEnabled = true;
        let currentNarrator = null;
        let isPlaying = false;
        let currentDemoAborted = false;
        let currentTaskId = null;
        let currentActiveButton = null;

        // Three.js variables
        let scene, camera, renderer;
        let particles = [];
        let currentActivity = 'none';
        let animationId;
        let particleSystem = null;
        let temperature = 25;

        // Button Management Functions
        function setActiveButton(buttonId) {
            // Remove active class from all buttons
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to the specified button
            if (buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.classList.add('active');
                    currentActiveButton = buttonId;
                }
            }
        }

        // Stop Current Demo with Complete Cleanup
        function stopCurrentDemo() {
            currentDemoAborted = true;
            currentTaskId = null;
            
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            
            hideProgress();
            isPlaying = false;
            
            // Remove active state from buttons after stop
            setTimeout(() => setActiveButton(null), 1000);
        }

        // Check if Demo Should Continue
        function shouldContinue(taskId = null) {
            if (taskId && currentTaskId && taskId !== currentTaskId) {
                return false;
            }
            return !currentDemoAborted;
        }

        // Create New Narrator
        function createNewNarrator(taskId = null) {
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            currentDemoAborted = false;
            currentTaskId = taskId;
            currentNarrator = new ParticleNarrator();
            return currentNarrator;
        }

        // Initialize Three.js
        function initThreeJS() {
            const canvas = document.getElementById('particleCanvas');
            const container = document.getElementById('stage');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = null;
            
            // Camera
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(0, 0, 15);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(width, height);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            const backLight = new THREE.DirectionalLight(0x667eea, 0.5);
            backLight.position.set(-5, -5, -5);
            scene.add(backLight);
            
            // Create initial particle system
            createInitialParticles();
            
            // Setup controls
            setupMouseControls();
            setupTemperatureControl();
            
            // Start animation loop
            animate();
        }

        // Create initial particle setup with proper spacing
        function createInitialParticles() {
            clearAllParticles();
            
            particleSystem = new THREE.Group();
            
            // Create water particles with collision-safe placement
            const waterCount = 100;
            const placedPositions = []; // Track placed particles
            const minSafeDistance = 0.4;
            
            for (let i = 0; i < waterCount; i++) {
                const geometry = new THREE.SphereGeometry(0.15, 16, 16);
                const material = new THREE.MeshPhongMaterial({
                    color: 0x4facfe,
                    emissive: 0x4facfe,
                    emissiveIntensity: 0.2,
                    transparent: true,
                    opacity: 0.8
                });
                
                const particle = new THREE.Mesh(geometry, material);
                
                // Find a safe position without overlap
                let safePosition = null;
                let attempts = 0;
                
                while (!safePosition && attempts < 50) {
                    const testPosition = new THREE.Vector3(
                        (Math.random() - 0.5) * 10,
                        (Math.random() - 0.5) * 8,
                        (Math.random() - 0.5) * 6
                    );
                    
                    // Check if position is safe from other particles
                    let isSafe = true;
                    for (let placed of placedPositions) {
                        if (testPosition.distanceTo(placed) < minSafeDistance) {
                            isSafe = false;
                            break;
                        }
                    }
                    
                    if (isSafe) {
                        safePosition = testPosition;
                        placedPositions.push(safePosition.clone());
                    }
                    
                    attempts++;
                }
                
                // If we couldn't find a safe position, place it further out
                if (!safePosition) {
                    safePosition = new THREE.Vector3(
                        (Math.random() - 0.5) * 15,
                        (Math.random() - 0.5) * 12,
                        (Math.random() - 0.5) * 10
                    );
                }
                
                particle.position.copy(safePosition);
                
                particle.userData = {
                    originalPosition: particle.position.clone(),
                    velocity: new THREE.Vector3(
                        (Math.random() - 0.5) * 0.02,
                        (Math.random() - 0.5) * 0.02,
                        (Math.random() - 0.5) * 0.02
                    ),
                    type: 'water',
                    baseSpeed: 0.02
                };
                
                particles.push(particle);
                particleSystem.add(particle);
            }
            
            scene.add(particleSystem);
        }

        function clearAllParticles() {
            if (particleSystem) {
                scene.remove(particleSystem);
            }
            particles = [];
        }

        // Create solute particles
        function createSoluteParticles(type = 'solute', count = 30) {
            const colors = {
                solute: 0xf5576c,
                fragrance: 0x9d4edd,
                ink: 0x1e40af
            };
            
            const color = colors[type] || 0xf5576c;
            const newParticles = [];
            
            for (let i = 0; i < count; i++) {
                const geometry = new THREE.SphereGeometry(0.12, 16, 16);
                const material = new THREE.MeshPhongMaterial({
                    color: color,
                    emissive: color,
                    emissiveIntensity: 0.3
                });
                
                const particle = new THREE.Mesh(geometry, material);
                particle.position.set(
                    -5 + (Math.random() - 0.5) * 2,
                    (Math.random() - 0.5) * 2,
                    (Math.random() - 0.5) * 2
                );
                
                particle.userData = {
                    originalPosition: particle.position.clone(),
                    velocity: new THREE.Vector3(0, 0, 0),
                    type: type,
                    baseSpeed: 0.03
                };
                
                particles.push(particle);
                newParticles.push(particle);
                particleSystem.add(particle);
            }
            
            return newParticles;
        }

        // Animate diffusion with collision detection
        async function animateDiffusion(particleArray, speed = 1) {
            return new Promise((resolve) => {
                let startTime = Date.now();
                const minDistance = 0.35;
                const separationForce = 0.08;
                
                const diffusionInterval = setInterval(() => {
                    if (!shouldContinue() || Date.now() - startTime > 8000) {
                        clearInterval(diffusionInterval);
                        resolve();
                        return;
                    }
                    
                    particleArray.forEach((particle, i) => {
                        // Add random diffusion velocity
                        particle.userData.velocity.add(new THREE.Vector3(
                            (Math.random() - 0.5) * 0.002 * speed,
                            (Math.random() - 0.5) * 0.002 * speed,
                            (Math.random() - 0.5) * 0.002 * speed
                        ));
                        
                        // Check collisions with all particles
                        particles.forEach((otherParticle, j) => {
                            if (particle !== otherParticle) {
                                const distance = particle.position.distanceTo(otherParticle.position);
                                
                                // Separate overlapping particles
                                if (distance < minDistance && distance > 0.01) {
                                    const separationVector = new THREE.Vector3()
                                        .subVectors(particle.position, otherParticle.position)
                                        .normalize()
                                        .multiplyScalar(separationForce * (minDistance - distance));
                                    
                                    particle.userData.velocity.add(separationVector);
                                }
                            }
                        });
                        
                        // Apply velocity
                        particle.position.add(particle.userData.velocity);
                        
                        // Boundary checks
                        if (Math.abs(particle.position.x) > 8) {
                            particle.userData.velocity.x *= -0.8;
                            particle.position.x = Math.sign(particle.position.x) * 8;
                        }
                        if (Math.abs(particle.position.y) > 5) {
                            particle.userData.velocity.y *= -0.8;
                            particle.position.y = Math.sign(particle.position.y) * 5;
                        }
                        if (Math.abs(particle.position.z) > 4) {
                            particle.userData.velocity.z *= -0.8;
                            particle.position.z = Math.sign(particle.position.z) * 4;
                        }
                        
                        // Damping
                        particle.userData.velocity.multiplyScalar(0.98);
                    });
                }, 50);
            });
        }

        // Update particles based on temperature with collision detection
        function updateParticles() {
            const tempFactor = temperature / 25;
            const minDistance = 0.35; // Minimum distance between particles
            const separationForce = 0.05; // Force to push overlapping particles apart
            
            particles.forEach((particle, i) => {
                if (particle.userData && particle.userData.velocity) {
                    // Temperature affects speed
                    const speedMultiplier = 0.5 + tempFactor * 0.5;
                    
                    // Add random motion
                    particle.userData.velocity.add(new THREE.Vector3(
                        (Math.random() - 0.5) * 0.001 * speedMultiplier,
                        (Math.random() - 0.5) * 0.001 * speedMultiplier,
                        (Math.random() - 0.5) * 0.001 * speedMultiplier
                    ));
                    
                    // Check collisions with other particles
                    particles.forEach((otherParticle, j) => {
                        if (i !== j) {
                            const distance = particle.position.distanceTo(otherParticle.position);
                            
                            // If particles are too close, separate them
                            if (distance < minDistance && distance > 0.01) {
                                const separationVector = new THREE.Vector3()
                                    .subVectors(particle.position, otherParticle.position)
                                    .normalize()
                                    .multiplyScalar(separationForce * (minDistance - distance));
                                
                                particle.userData.velocity.add(separationVector);
                            }
                        }
                    });
                    
                    // Apply velocity
                    particle.position.add(particle.userData.velocity);
                    
                    // Keep particles within bounds
                    const maxDistance = 10;
                    if (particle.position.length() > maxDistance) {
                        particle.position.normalize().multiplyScalar(maxDistance);
                        particle.userData.velocity.multiplyScalar(-0.5);
                    }
                    
                    // Damping
                    particle.userData.velocity.multiplyScalar(0.99);
                }
            });
        }

        // Setup mouse controls
        function setupMouseControls() {
            const canvas = renderer.domElement;
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging || !particleSystem) return;
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                particleSystem.rotation.y += deltaX * 0.01;
                particleSystem.rotation.x += deltaY * 0.01;
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(8, Math.min(25, camera.position.z));
            });
        }

        // Setup temperature control
        function setupTemperatureControl() {
            const slider = document.getElementById('tempSlider');
            const value = document.getElementById('tempValue');
            
            slider.addEventListener('input', (e) => {
                temperature = parseInt(e.target.value);
                value.textContent = `${temperature}°C`;
            });
        }

        // Animation loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Update particles
            updateParticles();
            
            // Gentle rotation when not playing demos
            if (particleSystem && !isPlaying) {
                particleSystem.rotation.y += 0.003;
            }
            
            renderer.render(scene, camera);
        }

        // Complete Lesson - Enhanced with full demonstrations
        async function playCompleteLesson() {
            const taskId = 'complete-lesson';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-complete');
            
            const narrator = createNewNarrator(taskId);
            await playCompleteLessonInternal(narrator, taskId);
            
            isPlaying = false;
            // Remove active state after completion
            setTimeout(() => setActiveButton(null), 2000);
        }

        async function playCompleteLessonInternal(narrator, taskId) {
            showProgress();
            
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("📚 Complete Particle Characteristics Journey");
            updateInfo("Introduction", "Your adventure through matter begins!");
            
            // Chapter 1: Introduction
            updateProgress(1);
            await narrator.speak("Welcome, young scientists! Today we're going on an amazing journey to discover the secret life of particles - the tiny building blocks that make up everything around us!");
            if (!shouldContinue(taskId)) return;
            
            await wait(1500);
            await narrator.speak("Have you ever wondered why sugar disappears in tea, or how the smell of your mom's cooking reaches your room? Let's find out together!");
            if (!shouldContinue(taskId)) return;
            
            // Chapter 2: Spaces Between Particles
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            updateProgress(2);
            updateInfo("Discovery 1", "The Hidden Spaces");
            
            await narrator.speak("Our first discovery is fascinating - particles have invisible spaces between them! Let me show you something amazing...");
            if (!shouldContinue(taskId)) return;
            
            const soluteParticles = createSoluteParticles('solute', 30);
            await wait(1500);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Watch these red particles carefully. They're like sugar molecules diving into your tea. See how they find spaces between the blue water particles? That's why a cup of tea doesn't overflow when you add sugar!");
            if (!shouldContinue(taskId)) return;
            
            await animateDiffusion(soluteParticles, 1.5);
            if (!shouldContinue(taskId)) return;
            
            // Chapter 3: Continuous Movement
            await wait(1500);
            if (!shouldContinue(taskId)) return;
            updateProgress(3);
            updateInfo("Discovery 2", "The Dance of Particles");
            
            await narrator.speak("All particles are constantly dancing! They never stop moving because they have something called kinetic energy. It's like they're at an endless party!");
            if (!shouldContinue(taskId)) return;
            
            // Create fragrance particles for movement demo
            const fragranceParticles = createSoluteParticles('fragrance', 25);
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Look at these purple fragrance particles. Even without any wind or stirring, they spread naturally. This is why you can smell lunch being cooked from another room!");
            if (!shouldContinue(taskId)) return;
            
            await animateDiffusion(fragranceParticles, 2);
            if (!shouldContinue(taskId)) return;
            
            // Temperature demonstration
            await wait(1000);
            await narrator.speak("Now here's something cool - or should I say hot? When we heat things up, particles dance even faster! Watch what happens when I raise the temperature...");
            if (!shouldContinue(taskId)) return;
            
            // Demonstrate temperature effect
            document.getElementById('tempSlider').value = 80;
            temperature = 80;
            document.getElementById('tempValue').textContent = '80°C';
            
            await wait(2500);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Wow! See how much faster they're moving? Hot particles are like excited dancers, while cold particles move slowly like they're sleepy. This explains why hot chocolate cools down - the fast particles gradually slow their dance!");
            if (!shouldContinue(taskId)) return;
            
            // Chapter 4: Attractive Forces
            await wait(1500);
            if (!shouldContinue(taskId)) return;
            updateProgress(4);
            updateInfo("Discovery 3", "The Invisible Glue");
            
            // Reset temperature for forces demo
            document.getElementById('tempSlider').value = 25;
            temperature = 25;
            document.getElementById('tempValue').textContent = '25°C';
            
            await narrator.speak("Particles have an invisible force that pulls them together - like tiny magnets! These forces are different for different materials.");
            if (!shouldContinue(taskId)) return;
            
            // Create clustered particles to show forces
            clearAllParticles();
            createInitialParticles();
            const clusteredParticles = [];
            for (let i = 0; i < 30; i++) {
                const particle = new THREE.Mesh(
                    new THREE.SphereGeometry(0.2, 16, 16),
                    new THREE.MeshPhongMaterial({
                        color: 0xf5576c,
                        emissive: 0xf5576c,
                        emissiveIntensity: 0.4
                    })
                );
                const angle = (i / 30) * Math.PI * 2;
                const radius = 2 + Math.random() * 0.5;
                particle.position.set(
                    Math.cos(angle) * radius,
                    (Math.random() - 0.5) * 2,
                    Math.sin(angle) * radius
                );
                clusteredParticles.push(particle);
                particles.push(particle);
                particleSystem.add(particle);
            }
            
            await wait(1500);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("In solids like iron, the forces are super strong - particles hold hands tightly! In liquids like water, they hold loosely. And in gases like air, they barely touch at all!");
            if (!shouldContinue(taskId)) return;
            
            // Animate clustering
            await new Promise((resolve) => {
                let time = 0;
                const clusterInterval = setInterval(() => {
                    if (!shouldContinue(taskId) || time > 60) {
                        clearInterval(clusterInterval);
                        resolve();
                        return;
                    }
                    clusteredParticles.forEach(particle => {
                        const toCenter = new THREE.Vector3(0, 0, 0).sub(particle.position);
                        toCenter.multiplyScalar(0.01);
                        particle.position.add(toCenter);
                    });
                    time++;
                }, 50);
            });
            
            // Chapter 5: Activity 1.3 Demo
            await wait(1500);
            if (!shouldContinue(taskId)) return;
            updateProgress(5);
            updateInfo("Activity 1.3", "The Incense Experiment");
            
            clearAllParticles();
            createInitialParticles();
            
            await narrator.speak("Let's try Activity 1.3 from your textbook! Imagine we're in your classroom with an incense stick...");
            if (!shouldContinue(taskId)) return;
            
            // Create and animate incense stick scenario
            const incenseGeometry = new THREE.CylinderGeometry(0.05, 0.05, 3, 8);
            const incenseMaterial = new THREE.MeshPhongMaterial({ color: 0x8b4513 });
            const incenseStick = new THREE.Mesh(incenseGeometry, incenseMaterial);
            incenseStick.position.set(-5, 0, 0);
            incenseStick.rotation.z = Math.PI / 6;
            scene.add(incenseStick);
            
            await narrator.speak("First, the incense is unlit. Can you smell it from your desk? No way! You'd have to walk right up to it. But watch what happens when we light it...");
            if (!shouldContinue(taskId)) return;
            
            // Add glowing tip
            const tipGeometry = new THREE.SphereGeometry(0.08, 16, 16);
            const tipMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xff4500, 
                emissive: 0xff4500, 
                emissiveIntensity: 0.8 
            });
            const glowingTip = new THREE.Mesh(tipGeometry, tipMaterial);
            glowingTip.position.set(-5, 1.5, 0);
            scene.add(glowingTip);
            
            // Create activity fragrance particles
            const activityFragranceParticles = [];
            for (let i = 0; i < 35; i++) {
                const particle = new THREE.Mesh(
                    new THREE.SphereGeometry(0.08, 16, 16),
                    new THREE.MeshPhongMaterial({
                        color: 0x9d4edd,
                        emissive: 0x9d4edd,
                        emissiveIntensity: 0.6,
                        transparent: true,
                        opacity: 0.9
                    })
                );
                particle.position.copy(glowingTip.position);
                particle.userData = {
                    velocity: new THREE.Vector3(
                        Math.random() * 0.1,
                        Math.random() * 0.02,
                        (Math.random() - 0.5) * 0.05
                    )
                };
                activityFragranceParticles.push(particle);
                scene.add(particle);
            }
            
            await animateDiffusion(activityFragranceParticles, 2);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Amazing! The heat gives particles energy to escape and spread. Now everyone in class can smell it! This proves particles move continuously and spread through diffusion!");
            if (!shouldContinue(taskId)) return;
            
            // Cleanup activity objects
            scene.remove(incenseStick);
            scene.remove(glowingTip);
            activityFragranceParticles.forEach(p => scene.remove(p));
            
            // Final wrap-up
            await wait(1500);
            await narrator.speak("What an incredible journey! We've discovered that particles have spaces, they're always moving, and they attract each other. These three simple properties explain everything - from why sugar dissolves to why we can smell flowers!");
            if (!shouldContinue(taskId)) return;
            
            await wait(1000);
            await narrator.speak("Remember, you're made of particles too! Every breath you take, every move you make - it's all about particles and their amazing properties. Keep exploring, young scientists!");
            
            hideProgress();
            updateInfo("Journey Complete!", "You're now a particle expert!");
            updateAnalysis("Congratulations! You've mastered the three characteristics of particles and understand how they create the world around us!");
        }

        // Individual Demonstrations
        async function showSpacesBetween() {
            const taskId = 'spaces-between';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-spaces');
            
            const narrator = createNewNarrator(taskId);
            await showSpacesBetweenInternal(narrator, taskId);
            
            isPlaying = false;
        }

        async function showSpacesBetweenInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🌌 Spaces Between Particles");
            updateInfo("Demonstration", "Particles have empty spaces");
            
            await narrator.speak("Let's prove that particles have spaces between them! Watch as we add solute particles to water. They'll fit into the empty spaces without increasing the total volume significantly.");
            if (!shouldContinue(taskId)) return;
            
            const soluteParticles = createSoluteParticles('solute', 40);
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("See how the red particles spread throughout the water? They're occupying the empty spaces between water molecules. This is why you can dissolve so much sugar in your tea!");
            if (!shouldContinue(taskId)) return;
            
            await animateDiffusion(soluteParticles, 1.5);
            
            updateAnalysis("Particles have spaces between them, allowing other particles to fit in during mixing and dissolution.");
        }

        async function showContinuousMovement() {
            const taskId = 'continuous-movement';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-movement');
            
            const narrator = createNewNarrator(taskId);
            await showContinuousMovementInternal(narrator, taskId);
            
            isPlaying = false;
        }

        async function showContinuousMovementInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🔥 Continuous Particle Movement");
            updateInfo("Kinetic Energy", "Particles never stop moving");
            
            await narrator.speak("Particles are in constant motion due to their kinetic energy. Even in seemingly still water, particles are vibrating and moving randomly!");
            if (!shouldContinue(taskId)) return;
            
            const fragranceParticles = createSoluteParticles('fragrance', 30);
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Watch these purple fragrance particles spread naturally without any stirring. This proves particles move on their own! Try adjusting the temperature to see how heat affects their speed.");
            if (!shouldContinue(taskId)) return;
            
            await animateDiffusion(fragranceParticles, 2);
            
            updateAnalysis("Particles possess kinetic energy and move continuously. Higher temperature increases movement speed.");
        }

        async function showAttractionForces() {
            const taskId = 'attraction-forces';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-forces');
            
            const narrator = createNewNarrator(taskId);
            await showAttractionForcesInternal(narrator, taskId);
            
            isPlaying = false;
        }

        async function showAttractionForcesInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🧲 Inter-particle Attractive Forces");
            updateInfo("Cohesion", "Forces hold particles together");
            
            await narrator.speak("Particles attract each other with intermolecular forces. These forces determine whether a substance is solid, liquid, or gas.");
            if (!shouldContinue(taskId)) return;
            
            const clusteredParticles = [];
            for (let i = 0; i < 30; i++) {
                const geometry = new THREE.SphereGeometry(0.2, 16, 16);
                const material = new THREE.MeshPhongMaterial({
                    color: 0xf5576c,
                    emissive: 0xf5576c,
                    emissiveIntensity: 0.4
                });
                
                const particle = new THREE.Mesh(geometry, material);
                const angle = (i / 30) * Math.PI * 2;
                const radius = 2 + Math.random() * 0.5;
                
                particle.position.set(
                    Math.cos(angle) * radius,
                    (Math.random() - 0.5) * 2,
                    Math.sin(angle) * radius
                );
                
                particle.userData = {
                    centerPoint: new THREE.Vector3(0, 0, 0),
                    velocity: new THREE.Vector3(0, 0, 0),
                    type: 'clustered'
                };
                
                clusteredParticles.push(particle);
                particles.push(particle);
                particleSystem.add(particle);
            }
            
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("See how these particles stay together in a cluster? That's because of attractive forces. Strong forces create solids like ice, moderate forces create liquids like water, and weak forces allow gases like steam to spread freely!");
            if (!shouldContinue(taskId)) return;
            
            await new Promise((resolve) => {
                let time = 0;
                const clusterInterval = setInterval(() => {
                    if (!shouldContinue(taskId) || time > 100) {
                        clearInterval(clusterInterval);
                        resolve();
                        return;
                    }
                    
                    clusteredParticles.forEach(particle => {
                        const toCenter = new THREE.Vector3().subVectors(
                            particle.userData.centerPoint,
                            particle.position
                        );
                        toCenter.multiplyScalar(0.01);
                        particle.userData.velocity.add(toCenter);
                        
                        particle.userData.velocity.add(new THREE.Vector3(
                            (Math.random() - 0.5) * 0.005,
                            (Math.random() - 0.5) * 0.005,
                            (Math.random() - 0.5) * 0.005
                        ));
                        
                        particle.position.add(particle.userData.velocity);
                        particle.userData.velocity.multiplyScalar(0.95);
                    });
                    
                    time++;
                }, 50);
            });
            
            updateAnalysis("Intermolecular forces vary in strength, determining physical states and material properties.");
        }

        async function showDiffusion() {
            const taskId = 'diffusion';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-diffusion');
            
            const narrator = createNewNarrator(taskId);
            await showDiffusionInternal(narrator, taskId);
            
            isPlaying = false;
        }

        async function showDiffusionInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("💨 Diffusion Process");
            updateInfo("Diffusion", "Particles spreading naturally");
            
            await narrator.speak("Diffusion is the process where particles spread from areas of high concentration to low concentration. This happens because of continuous particle movement!");
            if (!shouldContinue(taskId)) return;
            
            const inkParticles = createSoluteParticles('ink', 25);
            await wait(500);
            const fragranceParticles = createSoluteParticles('fragrance', 20);
            
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Watch as both blue ink and purple fragrance particles spread through the water. No stirring needed - the particles move and mix on their own due to their kinetic energy!");
            if (!shouldContinue(taskId)) return;
            
            await animateDiffusion([...inkParticles, ...fragranceParticles], 1.8);
            
            updateAnalysis("Diffusion demonstrates how continuous particle movement causes natural mixing and spreading of substances.");
        }

        // Activity Functions (simplified for space - implement full versions as needed)
        async function showActivity13() {
            const taskId = 'activity-13';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-activity13');
            
            const narrator = createNewNarrator(taskId);
            await showActivity13Internal(narrator, taskId);
            
            isPlaying = false;
        }

        async function showActivity13Internal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🔬 Activity 1.3: Incense Stick Experiment");
            updateInfo("Activity 1.3", "Fragrance diffusion demonstration");
            
            await narrator.speak("Let's perform Activity 1.3! We place an unlit incense stick in the corner. Can you smell it from far away? No! Now watch when we light it...");
            if (!shouldContinue(taskId)) return;
            
            const fragranceParticles = createSoluteParticles('fragrance', 40);
            await animateDiffusion(fragranceParticles, 2.5);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("The fragrance spreads throughout the room by diffusion - proving particles are always moving!");
            updateAnalysis("Activity 1.3 demonstrates how fragrance particles spread naturally through continuous movement.");
        }

        // Simplified versions of other activities
        async function showActivity14() {
            const taskId = 'activity-14';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-activity14');
            
            const narrator = createNewNarrator(taskId);
            
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🧪 Activity 1.4: Ink vs Honey Diffusion");
            updateInfo("Activity 1.4", "Comparing diffusion rates");
            
            await narrator.speak("Activity 1.4 compares how ink and honey diffuse in water. Ink spreads quickly, honey spreads slowly due to different particle sizes and properties!");
            
            const inkParticles = createSoluteParticles('ink', 30);
            await animateDiffusion(inkParticles, 2);
            
            updateAnalysis("Different substances have different diffusion rates based on particle properties.");
            isPlaying = false;
        }

        async function showActivity15() {
            const taskId = 'activity-15';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-activity15');
            
            const narrator = createNewNarrator(taskId);
            
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🌡️ Activity 1.5: Temperature Effect");
            updateInfo("Activity 1.5", "Temperature and dissolution");
            
            await narrator.speak("Activity 1.5 shows how temperature affects particle movement. Hot water dissolves crystals faster because particles have more kinetic energy!");
            
            // Demonstrate temperature effect
            document.getElementById('tempSlider').value = 70;
            temperature = 70;
            document.getElementById('tempValue').textContent = '70°C';
            
            await wait(3000);
            
            // Reset temperature
            document.getElementById('tempSlider').value = 25;
            temperature = 25;
            document.getElementById('tempValue').textContent = '25°C';
            
            updateAnalysis("Higher temperature increases particle kinetic energy and diffusion rate.");
            isPlaying = false;
        }

        // Simplified versions for activities 16-18
        async function showActivity16() {
            const taskId = 'activity-16';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-activity16');
            
            const narrator = createNewNarrator(taskId);
            
            await resetAll();
            updateTitle("💥 Activity 1.6: Human Chain Demo");
            updateInfo("Activity 1.6", "Modeling particle forces");
            
            await narrator.speak("Activity 1.6 uses human chains to represent different intermolecular forces. Strong bonds create solids, weak bonds allow gases to flow freely!");
            updateAnalysis("Human chains model how different force strengths create different material properties.");
            
            isPlaying = false;
        }

        async function showActivity17() {
            const taskId = 'activity-17';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-activity17');
            
            const narrator = createNewNarrator(taskId);
            
            await resetAll();
            updateTitle("🔨 Activity 1.7: Material Testing");
            updateInfo("Activity 1.7", "Testing material strength");
            
            await narrator.speak("Activity 1.7 tests different materials - iron, chalk, rubber. Each has different properties based on its particle bonds!");
            updateAnalysis("Material properties depend on the type and strength of intermolecular forces.");
            
            isPlaying = false;
        }

        async function showActivity18() {
            const taskId = 'activity-18';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-activity18');
            
            const narrator = createNewNarrator(taskId);
            
            await resetAll();
            updateTitle("💧 Activity 1.8: Surface Tension");
            updateInfo("Activity 1.8", "Water's surface tension");
            
            await narrator.speak("Activity 1.8 explores surface tension - hydrogen bonds between water molecules create an invisible skin on the water surface!");
            updateAnalysis("Surface tension demonstrates how intermolecular forces create observable properties.");
            
            isPlaying = false;
        }

        // Helper Functions
        async function resetAll() {
            if (currentNarrator) {
                currentNarrator.stop();
            }
            
            clearAllParticles();
            createInitialParticles();
            
            // Reset temperature
            document.getElementById('tempSlider').value = 25;
            temperature = 25;
            document.getElementById('tempValue').textContent = '25°C';
            
            updateInfo("Particle Properties", "Select a demonstration to explore");
            updateAnalysis("Matter particles have three key characteristics that explain all physical phenomena around us!");
            
            await wait(300);
        }

        async function resetAllClick() {
            stopCurrentDemo();
            isPlaying = false;
            setActiveButton('btn-reset');
            await resetAll();
            // Remove active state after reset
            setTimeout(() => setActiveButton(null), 1000);
        }

        function updateTitle(title) {
            document.getElementById('lesson-title').textContent = title;
        }

        function updateInfo(title, text) {
            document.getElementById('infoTitle').textContent = title;
            document.getElementById('infoText').textContent = text;
        }

        function updateAnalysis(text) {
            document.getElementById('current-analysis').textContent = text;
        }

        function showProgress() {
            document.getElementById('progressIndicator').style.display = 'flex';
        }

        function hideProgress() {
            document.getElementById('progressIndicator').style.display = 'none';
        }

        function updateProgress(step) {
            document.querySelectorAll('.progress-dot').forEach((dot, index) => {
                if (index < step) {
                    dot.classList.add('completed');
                    dot.classList.remove('active');
                } else if (index === step - 1) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active', 'completed');
                }
            });
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Audio Control
        document.getElementById('mute-btn').addEventListener('click', () => {
            globalAudioEnabled = !globalAudioEnabled;
            document.getElementById('mute-btn').classList.toggle('muted', !globalAudioEnabled);
            
            if (!globalAudioEnabled && currentNarrator) {
                currentNarrator.stop();
            }
            
            if (currentNarrator) {
                currentNarrator.isEnabled = globalAudioEnabled;
            }
        });

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        function initialize() {
            initThreeJS();
            const narrator = createNewNarrator('initialization');
            narrator.speak("Welcome to Particle Characteristics! Discover the three fundamental properties that define all matter. Select a demonstration to begin exploring!");
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const container = document.getElementById('stage');
            if (camera && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        });
    </script>
</body>
</html>