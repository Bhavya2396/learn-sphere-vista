<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1.4 Can Matter Change its State? - Interactive Learning</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 25%, #2c5364 50%, #203a43 75%, #0f2027 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(3px 3px at 20% 30%, rgba(173, 216, 230, 0.8), transparent),
                radial-gradient(3px 3px at 60% 70%, rgba(135, 206, 250, 0.8), transparent),
                radial-gradient(2px 2px at 50% 50%, rgba(255, 255, 255, 0.5), transparent);
            background-size: 250px 250px;
            opacity: 0.15;
            animation: drift 90s linear infinite;
            pointer-events: none;
        }

        @keyframes drift {
            from { transform: translate(0, 0); }
            to { transform: translate(-250px, -250px); }
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5, #00d2ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 20px rgba(0, 210, 255, 0.5)); }
            50% { filter: brightness(1.3) drop-shadow(0 0 40px rgba(58, 123, 213, 0.7)); }
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Simulation Stage */
        .simulation-stage {
            background: linear-gradient(135deg, 
                rgba(15, 23, 42, 0.95) 0%,
                rgba(30, 41, 59, 0.95) 50%,
                rgba(15, 23, 42, 0.95) 100%);
            border-radius: 20px;
            height: 500px;
            position: relative;
            margin: 40px 0;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 2px solid rgba(0, 210, 255, 0.3);
        }

        #simulationCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #simulationCanvas:active {
            cursor: grabbing;
        }

        /* Topic Display */
        .topic-display {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px 25px;
            border: 2px solid rgba(0, 210, 255, 0.5);
            z-index: 10;
            display: none;
            max-width: 350px;
        }

        .topic-title {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5, #00d2ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            animation: topicGlow 2s ease-in-out infinite alternate;
        }

        .topic-subtitle {
            font-size: 1rem;
            color: #e2e8f0;
            opacity: 0.9;
        }

        @keyframes topicGlow {
            0% { filter: brightness(1) drop-shadow(0 0 10px rgba(0, 210, 255, 0.5)); }
            100% { filter: brightness(1.3) drop-shadow(0 0 20px rgba(58, 123, 213, 0.7)); }
        }

        /* Temperature Display */
        .temperature-display {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 2px solid rgba(255, 107, 107, 0.5);
            min-width: 200px;
        }

        .temp-label {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .temp-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .state-label {
            font-size: 1.1rem;
            color: #4ecdc4;
            margin-top: 10px;
            font-weight: 600;
        }

        /* Control Panel */
        .controls {
            text-align: center;
            margin: 40px 0;
        }

        .temperature-slider {
            width: 60%;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid rgba(0, 210, 255, 0.2);
        }

        .slider-container {
            position: relative;
            margin: 20px 0;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(90deg, 
                #00d2ff 0%, 
                #3a7bd5 33%, 
                #ff6b6b 66%, 
                #ff0000 100%);
            outline: none;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 14px 28px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            min-width: 180px;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .action-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            }
            50% { 
                box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
            }
        }

        /* Concept Cards */
        .concept-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 50px 0;
        }

        .concept-card {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.6),
                rgba(30, 41, 59, 0.6));
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(0, 210, 255, 0.2);
            transition: all 0.3s ease;
        }

        .concept-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 210, 255, 0.4);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .concept-title {
            font-size: 1.5rem;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .concept-content {
            line-height: 1.8;
            color: #e2e8f0;
        }

        .formula-box {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            border: 1px solid rgba(0, 210, 255, 0.3);
        }

        .formula {
            font-size: 1.1rem;
            color: #ffd93d;
            font-family: 'Courier New', monospace;
        }

        /* Key Points */
        .key-points {
            list-style: none;
            padding: 0;
        }

        .key-points li {
            margin: 15px 0;
            padding-left: 30px;
            position: relative;
            line-height: 1.6;
        }

        .key-points li::before {
            content: '❄️';
            position: absolute;
            left: 0;
            top: 0;
        }

        /* Activity Section */
        .activity-section {
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.1),
                rgba(118, 75, 162, 0.1));
            border-radius: 20px;
            padding: 30px;
            margin: 40px 0;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        .activity-title {
            font-size: 1.8rem;
            text-align: center;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
            font-weight: 600;
        }

        .activity-steps {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .activity-steps ol {
            padding-left: 25px;
        }

        .activity-steps li {
            margin: 12px 0;
            line-height: 1.7;
            color: #e2e8f0;
        }

        /* Progress Indicator */
        .progress-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 10px 20px;
            display: none;
            z-index: 100;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #00d2ff;
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .simulation-stage { height: 400px; }
            .temperature-slider { width: 90%; }
            .concept-section { grid-template-columns: 1fr; }
            .control-buttons { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">🔊</span>
            <span class="mute-icon">🔇</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>1.4 Can Matter Change its State?</h1>
            <p>Explore how temperature and pressure affect the states of matter through interactive simulations</p>
        </div>

        <!-- Simulation Stage -->
        <div class="simulation-stage">
            <canvas id="simulationCanvas"></canvas>
            
            <!-- Topic Display -->
            <div class="topic-display" id="topicDisplay">
                <div class="topic-title" id="topicTitle">States of Matter</div>
                <div class="topic-subtitle" id="topicSubtitle">Interactive Learning Simulation</div>
            </div>
            
            <div class="temperature-display">
                <div class="temp-label">Temperature</div>
                <div class="temp-value" id="tempValue">273 K</div>
                <div class="state-label" id="stateLabel">SOLID (Ice)</div>
            </div>
        </div>

        <!-- Temperature Control -->
        <div class="controls">
            <div class="temperature-slider">
                <h3 style="margin-bottom: 20px; color: #00d2ff;">Temperature Control</h3>
                <div class="slider-container">
                    <input type="range" min="200" max="400" value="273" class="slider" id="tempSlider">
                    <div class="slider-labels">
                        <span>200 K</span>
                        <span>273 K (0°C)</span>
                        <span>373 K (100°C)</span>
                        <span>400 K</span>
                    </div>
                </div>
            </div>
            
            <div class="control-buttons">
                <button class="action-btn" id="btn-complete" onclick="playFullCycle()">🔄 Complete Cycle</button>
                <button class="action-btn" id="btn-melting" onclick="demonstrateMelting()">🧊 Melting Process</button>
                <button class="action-btn" id="btn-boiling" onclick="demonstrateBoiling()">💨 Boiling Process</button>
                <button class="action-btn" id="btn-sublimation" onclick="demonstrateSublimation()">✨ Sublimation</button>
                <button class="action-btn" id="btn-activity" onclick="performActivity112()">🔬 Activity 1.12</button>
                <button class="action-btn" id="btn-reset" onclick="resetSimulation()">↻ Reset</button>
            </div>
        </div>

        <!-- Concept Cards -->
        <div class="concept-section">
            <div class="concept-card">
                <h3 class="concept-title">Melting & Fusion</h3>
                <div class="concept-content">
                    <p>When solids are heated, particles gain kinetic energy and vibrate faster. At the melting point, they overcome intermolecular forces and become liquid.</p>
                    <div class="formula-box">
                        <div class="formula">Melting Point of Ice = 273.15 K (0°C)</div>
                    </div>
                    <p><strong>Latent Heat of Fusion:</strong> Energy required to change 1 kg of solid to liquid at melting point without temperature change.</p>
                </div>
            </div>
            
            <div class="concept-card">
                <h3 class="concept-title">Boiling & Vaporization</h3>
                <div class="concept-content">
                    <p>Liquid particles gain enough energy to break free from intermolecular forces completely, becoming gas. This happens throughout the liquid (bulk phenomenon).</p>
                    <div class="formula-box">
                        <div class="formula">Boiling Point of Water = 373 K (100°C)</div>
                    </div>
                    <p><strong>Latent Heat of Vaporization:</strong> Energy required to change 1 kg of liquid to gas at boiling point.</p>
                </div>
            </div>
        </div>

        <!-- Activity Section -->
        <div class="activity-section">
            <h2 class="activity-title">Activity 1.12: Observing State Changes</h2>
            <div class="activity-steps">
                <ol>
                    <li>Take 150g of ice in a beaker with a thermometer touching the ice</li>
                    <li>Heat the beaker on a low flame</li>
                    <li>Note the temperature when ice starts melting (273 K)</li>
                    <li>Observe that temperature remains constant during melting</li>
                    <li>Continue heating water until it starts boiling</li>
                    <li>Note the boiling temperature (373 K)</li>
                    <li>Temperature stays constant during boiling despite continuous heating</li>
                </ol>
            </div>
        </div>

        <!-- Key Concepts Section -->
        <div class="concept-card" style="margin: 40px 0;">
            <h3 class="concept-title">Key Concepts</h3>
            <ul class="key-points">
                <li>Matter exists in three states: solid, liquid, and gas</li>
                <li>Temperature remains constant during state changes (latent heat)</li>
                <li>Particles at 0°C water have more energy than ice at 0°C</li>
                <li>Steam at 100°C has more energy than water at 100°C</li>
                <li>Sublimation: Direct change from solid to gas (e.g., dry ice, camphor)</li>
                <li>Pressure affects state changes - high pressure can liquefy gases</li>
            </ul>
        </div>

        <!-- Special Cases -->
        <div class="concept-section">
            <div class="concept-card">
                <h3 class="concept-title">Sublimation</h3>
                <div class="concept-content">
                    <p>Some substances change directly from solid to gas without becoming liquid:</p>
                    <ul style="margin-top: 15px; padding-left: 25px;">
                        <li>Camphor sublimes at room temperature</li>
                        <li>Dry ice (solid CO₂) sublimes at 1 atm pressure</li>
                        <li>Iodine crystals sublime when heated gently</li>
                    </ul>
                </div>
            </div>
            
            <div class="concept-card">
                <h3 class="concept-title">Effect of Pressure</h3>
                <div class="concept-content">
                    <p>Pressure can force particles closer together, changing states:</p>
                    <ul style="margin-top: 15px; padding-left: 25px;">
                        <li>High pressure can liquefy gases</li>
                        <li>CO₂ is stored as solid under high pressure</li>
                        <li>Pressure and temperature together determine state</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Container -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-text" id="progressText">Loading...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <script>
        // Voice Narrator
        class Narrator {
            constructor() {
                this.isEnabled = globalAudioEnabled;
                this.currentUtterance = null;
                this.settings = { rate: 0.9, pitch: 1.0, volume: 0.85 };
                this.isDestroyed = false;
            }

            async speak(text, delay = 0) {
                if (!this.isEnabled || !text || this.isDestroyed) return;
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (this.isDestroyed) {
                            resolve();
                            return;
                        }
                        this.stop();
                        const utterance = new SpeechSynthesisUtterance(text);
                        Object.assign(utterance, this.settings);
                        
                        utterance.onend = resolve;
                        utterance.onerror = resolve;
                        
                        this.currentUtterance = utterance;
                        speechSynthesis.speak(utterance);
                    }, delay);
                });
            }

            stop() {
                speechSynthesis.cancel();
                this.currentUtterance = null;
            }

            destroy() {
                this.isDestroyed = true;
                this.stop();
                this.currentUtterance = null;
                this.settings = null;
            }
        }

        // Global State Management
        let globalAudioEnabled = true;
        let currentNarrator = null;
        let isPlaying = false;
        let currentDemoAborted = false;
        let currentTaskId = null;
        let currentActiveButton = null;

        // Global variables
        let scene, camera, renderer;
        let particles = [];
        let animationId;
        let currentTemperature = 273;
        let targetTemperature = 273;
        let particleSystem;

        // Button Management Functions
        function setActiveButton(buttonId) {
            // Remove active class from all buttons
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to the specified button
            if (buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.classList.add('active');
                    currentActiveButton = buttonId;
                }
            }
        }

        // Stop Current Demo with Complete Cleanup
        function stopCurrentDemo() {
            currentDemoAborted = true;
            currentTaskId = null;
            
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            
            hideProgress();
            isPlaying = false;
            
            // Remove active state from buttons after stop
            setTimeout(() => setActiveButton(null), 1000);
        }

        // Check if Demo Should Continue
        function shouldContinue(taskId = null) {
            if (taskId && currentTaskId && taskId !== currentTaskId) {
                return false;
            }
            return !currentDemoAborted;
        }

        // Create New Narrator
        function createNewNarrator(taskId = null) {
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            currentDemoAborted = false;
            currentTaskId = taskId;
            currentNarrator = new Narrator();
            return currentNarrator;
        }

        // Initialize Three.js
        function initThreeJS() {
            const canvas = document.getElementById('simulationCanvas');
            const container = document.querySelector('.simulation-stage');
            
            scene = new THREE.Scene();
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 1000);
            camera.position.set(0, 0, 30);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(width, height);
            renderer.setClearColor(0x000000, 0);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            createParticleSystem();
            setupMouseControls();
            animate();
        }

        // Create particle system for water molecules
        function createParticleSystem() {
            particles = [];
            particleSystem = new THREE.Group();
            
            const particleCount = 100;
            const geometry = new THREE.SphereGeometry(0.3, 16, 16);
            
            for (let i = 0; i < particleCount; i++) {
                // Create H2O molecule representation
                const molecule = new THREE.Group();
                
                // Oxygen (larger, red)
                const oxygenMaterial = new THREE.MeshPhongMaterial({
                    color: 0xff4444,
                    emissive: 0xff4444,
                    emissiveIntensity: 0.2
                });
                const oxygen = new THREE.Mesh(geometry, oxygenMaterial);
                molecule.add(oxygen);
                
                // Hydrogen atoms (smaller, white)
                const hydrogenGeometry = new THREE.SphereGeometry(0.2, 16, 16);
                const hydrogenMaterial = new THREE.MeshPhongMaterial({
                    color: 0xffffff,
                    emissive: 0xffffff,
                    emissiveIntensity: 0.2
                });
                
                const hydrogen1 = new THREE.Mesh(hydrogenGeometry, hydrogenMaterial);
                hydrogen1.position.set(0.5, 0.3, 0);
                molecule.add(hydrogen1);
                
                const hydrogen2 = new THREE.Mesh(hydrogenGeometry, hydrogenMaterial);
                hydrogen2.position.set(-0.5, 0.3, 0);
                molecule.add(hydrogen2);
                
                // Position molecule in grid for solid state
                const gridSize = 5;
                const spacing = 2;
                const row = Math.floor(i / gridSize);
                const col = i % gridSize;
                const layer = Math.floor(row / gridSize);
                
                molecule.position.x = (col - gridSize/2) * spacing;
                molecule.position.y = (row % gridSize - gridSize/2) * spacing;
                molecule.position.z = (layer - 1) * spacing;
                
                molecule.userData = {
                    originalPos: molecule.position.clone(),
                    velocity: new THREE.Vector3(),
                    vibrationPhase: Math.random() * Math.PI * 2
                };
                
                particles.push(molecule);
                particleSystem.add(molecule);
            }
            
            scene.add(particleSystem);
        }

        // Update particle behavior based on temperature
        function updateParticles() {
            const time = Date.now() * 0.001;
            
            particles.forEach((particle, i) => {
                if (currentTemperature < 273) {
                    // SOLID STATE - Ice
                    const vibrationAmount = (currentTemperature - 200) / 73 * 0.1;
                    particle.position.x = particle.userData.originalPos.x + 
                        Math.sin(time * 3 + particle.userData.vibrationPhase) * vibrationAmount;
                    particle.position.y = particle.userData.originalPos.y + 
                        Math.cos(time * 3 + particle.userData.vibrationPhase * 1.5) * vibrationAmount;
                    particle.position.z = particle.userData.originalPos.z + 
                        Math.sin(time * 3 + particle.userData.vibrationPhase * 2) * vibrationAmount;
                    
                } else if (currentTemperature >= 273 && currentTemperature < 373) {
                    // LIQUID STATE - Water
                    const mobility = (currentTemperature - 273) / 100;
                    
                    // Particles move more freely but stay somewhat together
                    particle.userData.velocity.x += (Math.random() - 0.5) * mobility * 0.01;
                    particle.userData.velocity.y += (Math.random() - 0.5) * mobility * 0.01;
                    particle.userData.velocity.z += (Math.random() - 0.5) * mobility * 0.01;
                    
                    // Apply damping
                    particle.userData.velocity.multiplyScalar(0.98);
                    
                    // Update position
                    particle.position.add(particle.userData.velocity);
                    
                    // Keep particles within bounds
                    const bound = 8;
                    if (Math.abs(particle.position.x) > bound) {
                        particle.position.x = Math.sign(particle.position.x) * bound;
                        particle.userData.velocity.x *= -0.5;
                    }
                    if (Math.abs(particle.position.y) > bound) {
                        particle.position.y = Math.sign(particle.position.y) * bound;
                        particle.userData.velocity.y *= -0.5;
                    }
                    if (Math.abs(particle.position.z) > bound) {
                        particle.position.z = Math.sign(particle.position.z) * bound;
                        particle.userData.velocity.z *= -0.5;
                    }
                    
                } else {
                    // GAS STATE - Steam
                    const energy = (currentTemperature - 373) / 27 + 1;
                    
                    // Particles move very freely
                    particle.userData.velocity.x += (Math.random() - 0.5) * energy * 0.02;
                    particle.userData.velocity.y += (Math.random() - 0.5) * energy * 0.02;
                    particle.userData.velocity.z += (Math.random() - 0.5) * energy * 0.02;
                    
                    // Less damping for gas
                    particle.userData.velocity.multiplyScalar(0.99);
                    
                    // Update position
                    particle.position.add(particle.userData.velocity);
                    
                    // Wrap around (gas fills container)
                    const bound = 12;
                    if (Math.abs(particle.position.x) > bound) {
                        particle.position.x = -Math.sign(particle.position.x) * bound;
                    }
                    if (Math.abs(particle.position.y) > bound) {
                        particle.position.y = -Math.sign(particle.position.y) * bound;
                    }
                    if (Math.abs(particle.position.z) > bound) {
                        particle.position.z = -Math.sign(particle.position.z) * bound;
                    }
                }
                
                // Rotate molecules slightly
                particle.rotation.x += 0.01;
                particle.rotation.y += 0.01;
            });
        }

        // Update temperature display
        function updateTemperatureDisplay() {
            const tempValue = document.getElementById('tempValue');
            const stateLabel = document.getElementById('stateLabel');
            
            tempValue.textContent = Math.round(currentTemperature) + ' K';
            
            if (currentTemperature < 273) {
                stateLabel.textContent = 'SOLID (Ice)';
                stateLabel.style.color = '#00d2ff';
            } else if (currentTemperature >= 273 && currentTemperature < 373) {
                stateLabel.textContent = 'LIQUID (Water)';
                stateLabel.style.color = '#3a7bd5';
            } else {
                stateLabel.textContent = 'GAS (Steam)';
                stateLabel.style.color = '#ff6b6b';
            }
        }

        // Temperature slider handler
        document.getElementById('tempSlider').addEventListener('input', (e) => {
            targetTemperature = parseFloat(e.value);
        });

        // Enhanced Activity 1.12 - Step-by-step classroom demonstration
        async function performActivity112() {
            const taskId = 'activity-112';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-activity');
            
            const narrator = createNewNarrator(taskId);
            await performActivity112Internal(narrator, taskId);
            
            isPlaying = false;
            hideTopicDisplay();
            // Remove active state after completion
            setTimeout(() => setActiveButton(null), 2000);
        }

        async function performActivity112Internal(narrator, taskId) {
            showProgress('Setting up Activity 1.12...', 0);
            updateTopicDisplay('ACTIVITY 1.12', 'Setting up classroom experiment...');
            
            await narrator.speak("Welcome to Activity 1.12! We're going to observe how ice melts and water boils while carefully measuring temperature changes. This is just like the experiment in your textbook!");
            if (!shouldContinue(taskId)) return;
            
            // Step 1: Setup
            showProgress('Step 1: Setting up the experiment', 10);
            updateTopicDisplay('ACTIVITY 1.12 - SETUP', '150g ice + thermometer + beaker');
            targetTemperature = 250;
            document.getElementById('tempSlider').value = 250;
            await wait(1500);
            
            await narrator.speak("Step 1: We have 150 grams of ice in a beaker with a thermometer touching the ice. The initial temperature is below freezing.");
            if (!shouldContinue(taskId)) return;
            
            // Step 2: Start heating
            showProgress('Step 2: Starting to heat the ice', 20);
            updateTopicDisplay('ACTIVITY 1.12 - HEATING', 'Applying heat to ice - low flame');
            await wait(2000);
            
            await narrator.speak("Step 2: Now we place the beaker on a low flame and start heating. Watch the temperature rise slowly as we add heat energy.");
            if (!shouldContinue(taskId)) return;
            
            // Step 3: Approach melting point
            showProgress('Step 3: Approaching melting point', 30);
            updateTopicDisplay('ACTIVITY 1.12 - HEATING ICE', 'Temperature rising steadily...');
            for (let t = 250; t <= 270; t += 3) {
                targetTemperature = t;
                document.getElementById('tempSlider').value = t;
                await wait(200);
                if (!shouldContinue(taskId)) return;
            }
            
            await narrator.speak("Notice how the temperature is rising steadily as we heat the ice. The particles are vibrating more and more as they gain energy.");
            if (!shouldContinue(taskId)) return;
            
            // Step 4: Melting begins
            showProgress('Step 4: Ice starts melting at 273K', 40);
            updateTopicDisplay('ACTIVITY 1.12 - MELTING!', 'Ice melting at 273K - Observe!');
            targetTemperature = 273;
            document.getElementById('tempSlider').value = 273;
            await wait(2000);
            
            await narrator.speak("Step 3: Amazing! The ice starts melting at exactly 273 Kelvin or 0 degrees Celsius. This is the melting point of ice!");
            if (!shouldContinue(taskId)) return;
            
            // Step 5: Temperature plateau during melting
            showProgress('Step 5: Temperature remains constant during melting', 50);
            updateTopicDisplay('ACTIVITY 1.12 - KEY OBSERVATION', 'Temperature constant while melting!');
            await wait(3000);
            
            await narrator.speak("Step 4: Here's the key observation! Even though we keep heating, the temperature stays constant at 273K while the ice melts. All the heat energy is being used to break the bonds between ice particles!");
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("This energy is called the latent heat of fusion. The particles at 0 degree water have more energy than ice at 0 degrees, even though the temperature is the same!");
            if (!shouldContinue(taskId)) return;
            
            // Step 6: Continue heating water
            showProgress('Step 6: All ice melted, heating water', 60);
            updateTopicDisplay('ACTIVITY 1.12 - HEATING WATER', 'Liquid water temperature rising...');
            await wait(2000);
            
            await narrator.speak("Step 5: Now all the ice has melted into water. As we continue heating, the temperature starts rising again as water particles gain more kinetic energy.");
            if (!shouldContinue(taskId)) return;
            
            for (let t = 273; t <= 370; t += 4) {
                targetTemperature = t;
                document.getElementById('tempSlider').value = t;
                await wait(150);
                if (!shouldContinue(taskId)) return;
            }
            
            // Step 7: Boiling begins
            showProgress('Step 7: Water starts boiling at 373K', 80);
            updateTopicDisplay('ACTIVITY 1.12 - BOILING!', 'Water boiling at 373K - Observe!');
            targetTemperature = 373;
            document.getElementById('tempSlider').value = 373;
            await wait(2000);
            
            await narrator.speak("Step 6: At 373 Kelvin or 100 degrees Celsius, the water starts boiling! Bubbles form throughout the liquid as water changes to steam.");
            if (!shouldContinue(taskId)) return;
            
            // Step 8: Temperature plateau during boiling
            showProgress('Step 8: Temperature constant during boiling', 90);
            updateTopicDisplay('ACTIVITY 1.12 - KEY OBSERVATION', 'Temperature constant while boiling!');
            await wait(4000);
            
            await narrator.speak("Step 7: Just like melting, the temperature stays constant at 373K during boiling! The heat energy is used to completely separate water molecules into gas. This is called latent heat of vaporization.");
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Steam at 100 degrees Celsius has much more energy than water at 100 degrees Celsius - that's why steam burns are more dangerous!");
            if (!shouldContinue(taskId)) return;
            
            // Conclusion
            showProgress('Activity 1.12 Complete!', 100);
            updateTopicDisplay('ACTIVITY 1.12 - COMPLETE!', 'Experiment successfully finished!');
            await wait(1500);
            
            await narrator.speak("Activity 1.12 complete! We observed that temperature remains constant during state changes even though we keep adding heat. This proves that changing states requires latent heat energy to break or form intermolecular forces.");
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Remember: melting point 273K, boiling point 373K, and temperature stays constant during both phase changes!");
            
            hideProgress();
        }

        // Topic Display Functions
        function showTopicDisplay(title, subtitle) {
            const topicDisplay = document.getElementById('topicDisplay');
            const topicTitle = document.getElementById('topicTitle');
            const topicSubtitle = document.getElementById('topicSubtitle');
            
            topicTitle.textContent = title;
            topicSubtitle.textContent = subtitle;
            topicDisplay.style.display = 'block';
        }

        function hideTopicDisplay() {
            const topicDisplay = document.getElementById('topicDisplay');
            topicDisplay.style.display = 'none';
        }

        function updateTopicDisplay(title, subtitle) {
            showTopicDisplay(title, subtitle);
        }
        async function playFullCycle() {
            const taskId = 'complete-cycle';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-complete');
            
            const narrator = createNewNarrator(taskId);
            await playFullCycleInternal(narrator, taskId);
            
            isPlaying = false;
            // Remove active state after completion
            setTimeout(() => setActiveButton(null), 2000);
        }

        async function playFullCycleInternal(narrator, taskId) {
            showProgress('Starting Complete Cycle with All Processes...', 0);
            
            await narrator.speak("Welcome to the complete cycle! We'll explore melting process, boiling process, sublimation, and perform Activity 1.12. Let's begin this comprehensive journey through all state changes!");
            if (!shouldContinue(taskId)) return;
            
            // Section 1: Melting Process
            showProgress('Section 1: Detailed Melting Process', 10);
            targetTemperature = 250;
            document.getElementById('tempSlider').value = 250;
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("First, the melting process! Starting with ice at 250 Kelvin. Watch as we gradually heat it to observe the complete melting phenomenon.");
            if (!shouldContinue(taskId)) return;
            
            // Gradual heating to melting point
            for (let t = 250; t <= 270; t += 2) {
                targetTemperature = t;
                document.getElementById('tempSlider').value = t;
                await wait(200);
                if (!shouldContinue(taskId)) return;
            }
            
            await narrator.speak("Temperature rising steadily as ice molecules vibrate faster. Now approaching the critical melting point!");
            if (!shouldContinue(taskId)) return;
            
            // At melting point
            targetTemperature = 273;
            document.getElementById('tempSlider').value = 273;
            await wait(3000);
            
            await narrator.speak("At 273 Kelvin, melting begins! Notice temperature stays constant - this demonstrates latent heat of fusion. All energy breaks intermolecular bonds, not raising temperature.");
            if (!shouldContinue(taskId)) return;
            
            // Continue to liquid
            targetTemperature = 290;
            document.getElementById('tempSlider').value = 290;
            await wait(2000);
            
            await narrator.speak("Melting process complete! Ice has transformed to liquid water. Now let's explore the boiling process.");
            if (!shouldContinue(taskId)) return;
            
            // Section 2: Boiling Process
            showProgress('Section 2: Detailed Boiling Process', 35);
            await wait(1500);
            
            await narrator.speak("Second, the boiling process! We'll heat liquid water until it transforms completely into steam.");
            if (!shouldContinue(taskId)) return;
            
            // Heat to near boiling
            for (let t = 290; t <= 370; t += 3) {
                targetTemperature = t;
                document.getElementById('tempSlider').value = t;
                await wait(120);
                if (!shouldContinue(taskId)) return;
            }
            
            await narrator.speak("Water temperature rising rapidly. Molecules gaining kinetic energy, moving faster and faster. Approaching boiling point!");
            if (!shouldContinue(taskId)) return;
            
            // At boiling point
            for (let t = 370; t <= 373; t += 1) {
                targetTemperature = t;
                document.getElementById('tempSlider').value = t;
                await wait(300);
                if (!shouldContinue(taskId)) return;
            }
            
            await wait(3000);
            await narrator.speak("At 373 Kelvin, boiling begins! Again, temperature stays constant during the phase change. This is latent heat of vaporization - much higher than fusion heat!");
            if (!shouldContinue(taskId)) return;
            
            // Continue to gas
            targetTemperature = 385;
            document.getElementById('tempSlider').value = 385;
            await wait(2000);
            
            await narrator.speak("Boiling process complete! Water has transformed into steam. Now let's see something special - sublimation!");
            if (!shouldContinue(taskId)) return;
            
            // Section 3: Sublimation Process
            showProgress('Section 3: Sublimation - Solid to Gas Direct', 60);
            await wait(1500);
            
            await narrator.speak("Third, sublimation! This amazing process skips the liquid state entirely - solid goes directly to gas. Let's demonstrate this!");
            if (!shouldContinue(taskId)) return;
            
            // Reset to solid state
            targetTemperature = 240;
            document.getElementById('tempSlider').value = 240;
            await wait(2000);
            
            await narrator.speak("Starting with solid at very low temperature. In sublimation, we apply enough energy for molecules to escape directly from solid to gas state!");
            if (!shouldContinue(taskId)) return;
            
            await wait(1500);
            
            // Direct jump to gas (simulating sublimation)
            targetTemperature = 380;
            document.getElementById('tempSlider').value = 380;
            await wait(1000);
            
            await narrator.speak("Watch this! Direct transformation from solid to gas - no liquid phase! This happens with dry ice, camphor, and iodine crystals under specific conditions.");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            await narrator.speak("Sublimation complete! The solid has transformed directly into gas, demonstrating this special phase change. Now for our classroom experiment!");
            if (!shouldContinue(taskId)) return;
            
            // Section 4: Activity 1.12
            showProgress('Section 4: Activity 1.12 - Classroom Experiment', 80);
            await wait(1500);
            
            await narrator.speak("Finally, Activity 1.12! Let's perform the complete classroom experiment - heating ice and observing both melting and boiling with temperature measurements.");
            if (!shouldContinue(taskId)) return;
            
            // Reset for activity
            targetTemperature = 250;
            document.getElementById('tempSlider').value = 250;
            await wait(1500);
            
            await narrator.speak("Activity setup: 150 grams of ice in beaker, thermometer touching ice. Initial temperature below freezing. Starting to heat on low flame.");
            if (!shouldContinue(taskId)) return;
            
            // Activity heating to melting
            for (let t = 250; t <= 273; t += 2) {
                targetTemperature = t;
                document.getElementById('tempSlider').value = t;
                await wait(200);
                if (!shouldContinue(taskId)) return;
            }
            
            await narrator.speak("Observation 1: Ice starts melting at exactly 273 Kelvin. Temperature remains constant during melting despite continued heating!");
            if (!shouldContinue(taskId)) return;
            
            await wait(2000);
            
            // Continue heating through liquid
            for (let t = 273; t <= 373; t += 4) {
                targetTemperature = t;
                document.getElementById('tempSlider').value = t;
                await wait(150);
                if (!shouldContinue(taskId)) return;
            }
            
            await narrator.speak("Observation 2: After melting, water temperature rises steadily. Now approaching boiling point at 373 Kelvin!");
            if (!shouldContinue(taskId)) return;
            
            await wait(3000);
            await narrator.speak("Observation 3: Water boils at 373 Kelvin! Temperature again stays constant during boiling. Key learning: constant temperature during phase changes proves latent heat concept!");
            if (!shouldContinue(taskId)) return;
            
            // Final summary
            showProgress('Complete Cycle Finished - All Processes Demonstrated!', 100);
            await wait(2000);
            
            await narrator.speak("Complete cycle finished! We demonstrated all four processes: melting process with latent heat of fusion, boiling process with latent heat of vaporization, sublimation showing direct solid-to-gas transformation, and Activity 1.12 proving temperature stays constant during phase changes!");
            if (!shouldContinue(taskId)) return;
            
            await wait(1500);
            await narrator.speak("These four processes explain all matter state changes in nature - from ice melting in your drink, to water boiling in a kettle, to dry ice subliming, to the scientific proof through careful measurement!");
            
            hideProgress();
        }

        // Demonstration functions with enhanced button management and topic display
        async function demonstrateMelting() {
            const taskId = 'melting-demo';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-melting');
            
            const narrator = createNewNarrator(taskId);
            
            showProgress('Demonstrating melting process...', 0);
            updateTopicDisplay('MELTING PROCESS', 'Ice to Water - Solid to Liquid');
            
            // Start at solid
            targetTemperature = 250;
            document.getElementById('tempSlider').value = 250;
            await wait(1000);
            
            await narrator.speak('Starting with ice below freezing point. Watch as we heat it to melting point.');
            if (!shouldContinue(taskId)) return;
            
            // Heat to melting point
            showProgress('Heating to melting point...', 30);
            for (let t = 250; t <= 273; t += 2) {
                targetTemperature = t;
                document.getElementById('tempSlider').value = t;
                await wait(100);
                if (!shouldContinue(taskId)) return;
            }
            
            showProgress('Melting at constant temperature...', 60);
            updateTopicDisplay('MELTING AT 273K', 'Latent Heat of Fusion');
            await narrator.speak('At 273 Kelvin, ice melts. Temperature stays constant as latent heat breaks bonds between molecules.');
            if (!shouldContinue(taskId)) return;
            await wait(3000);
            
            // Continue to liquid
            showProgress('Ice fully melted to water', 90);
            updateTopicDisplay('MELTING COMPLETE', 'Solid has become Liquid Water');
            targetTemperature = 290;
            document.getElementById('tempSlider').value = 290;
            await wait(2000);
            
            showProgress('Complete!', 100);
            await wait(1000);
            hideProgress();
            hideTopicDisplay();
            isPlaying = false;
            setTimeout(() => setActiveButton(null), 2000);
        }

        async function demonstrateBoiling() {
            const taskId = 'boiling-demo';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-boiling');
            
            const narrator = createNewNarrator(taskId);
            
            showProgress('Demonstrating boiling process...', 0);
            updateTopicDisplay('BOILING PROCESS', 'Water to Steam - Liquid to Gas');
            
            // Start at liquid
            targetTemperature = 350;
            document.getElementById('tempSlider').value = 350;
            await wait(1000);
            
            await narrator.speak('Starting with liquid water. Heating to boiling point at 373 Kelvin.');
            if (!shouldContinue(taskId)) return;
            
            // Heat to boiling point
            showProgress('Heating to boiling point...', 30);
            for (let t = 350; t <= 373; t += 2) {
                targetTemperature = t;
                document.getElementById('tempSlider').value = t;
                await wait(100);
                if (!shouldContinue(taskId)) return;
            }
            
            showProgress('Boiling at constant temperature...', 60);
            updateTopicDisplay('BOILING AT 373K', 'Latent Heat of Vaporization');
            await narrator.speak('At 373 Kelvin, water boils. Particles gain enough energy to escape as gas.');
            if (!shouldContinue(taskId)) return;
            await wait(3000);
            
            // Continue to gas
            showProgress('Water fully vaporized to steam', 90);
            updateTopicDisplay('BOILING COMPLETE', 'Liquid has become Steam Gas');
            targetTemperature = 390;
            document.getElementById('tempSlider').value = 390;
            await wait(2000);
            
            showProgress('Complete!', 100);
            await wait(1000);
            hideProgress();
            hideTopicDisplay();
            isPlaying = false;
            setTimeout(() => setActiveButton(null), 2000);
        }

        async function demonstrateSublimation() {
            const taskId = 'sublimation-demo';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-sublimation');
            
            const narrator = createNewNarrator(taskId);
            
            showProgress('Demonstrating sublimation...', 0);
            updateTopicDisplay('SUBLIMATION PROCESS', 'Solid to Gas - Skipping Liquid!');
            
            await narrator.speak('Sublimation: direct change from solid to gas, skipping liquid state. Like dry ice or camphor.');
            if (!shouldContinue(taskId)) return;
            
            // Start at solid
            targetTemperature = 250;
            document.getElementById('tempSlider').value = 250;
            await wait(1000);
            
            showProgress('Solid state...', 20);
            await wait(1500);
            
            // Jump directly to gas
            showProgress('Direct transition to gas!', 60);
            updateTopicDisplay('SUBLIMATION IN ACTION', 'Solid → Gas (No Liquid Phase)');
            targetTemperature = 380;
            document.getElementById('tempSlider').value = 380;
            
            await wait(3000);
            
            showProgress('Sublimation complete!', 100);
            updateTopicDisplay('SUBLIMATION COMPLETE', 'Direct Solid-to-Gas Transformation Done');
            await narrator.speak('The solid transformed directly into gas without becoming liquid!');
            if (!shouldContinue(taskId)) return;
            await wait(2000);
            hideProgress();
            hideTopicDisplay();
            isPlaying = false;
            setTimeout(() => setActiveButton(null), 2000);
        }

        function resetSimulation() {
            stopCurrentDemo();
            setActiveButton('btn-reset');
            
            targetTemperature = 273;
            currentTemperature = 273;
            document.getElementById('tempSlider').value = 273;
            
            // Reset particle positions
            particles.forEach((particle, i) => {
                particle.position.copy(particle.userData.originalPos);
                particle.userData.velocity.set(0, 0, 0);
            });
            
            updateTemperatureDisplay();
            hideTopicDisplay();
            const narrator = createNewNarrator();
            narrator.speak('Simulation reset to freezing point.');
            setTimeout(() => setActiveButton(null), 2000);
        }

        // Helper Functions
        function updateTitle(title) {
            // This function would update a title element if it existed in this file
            // The matter state changes file doesn't have this element, so we'll skip it
        }

        function updateInfo(title, text) {
            // This function would update info elements if they existed in this file
            // The matter state changes file doesn't have these elements, so we'll skip it
        }

        function updateCurrentInfo(text) {
            // This function would update current info element if it existed in this file
            // The matter state changes file doesn't have this element, so we'll skip it
        }

        async function resetAll() {
            if (currentNarrator) {
                currentNarrator.stop();
            }
            
            targetTemperature = 273;
            currentTemperature = 273;
            document.getElementById('tempSlider').value = 273;
            
            // Reset particle positions
            particles.forEach((particle, i) => {
                particle.position.copy(particle.userData.originalPos);
                particle.userData.velocity.set(0, 0, 0);
            });
            
            updateTemperatureDisplay();
            await wait(300);
        }
        function showProgress(text, percent = 0) {
            const container = document.getElementById('progressContainer');
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            container.style.display = 'block';
            progressText.textContent = text;
            progressFill.style.width = percent + '%';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Mouse controls
        function setupMouseControls() {
            const canvas = renderer.domElement;
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                particleSystem.rotation.y += deltaX * 0.01;
                particleSystem.rotation.x += deltaY * 0.01;
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(20, Math.min(50, camera.position.z));
            });
        }

        // Animation loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Smoothly adjust temperature
            if (Math.abs(currentTemperature - targetTemperature) > 0.5) {
                currentTemperature += (targetTemperature - currentTemperature) * 0.1;
                updateTemperatureDisplay();
            }
            
            updateParticles();
            
            // Gentle rotation
            particleSystem.rotation.y += 0.002;
            
            renderer.render(scene, camera);
        }

        // Audio control
        document.getElementById('mute-btn').addEventListener('click', () => {
            globalAudioEnabled = !globalAudioEnabled;
            document.getElementById('mute-btn').classList.toggle('muted', !globalAudioEnabled);
            
            if (!globalAudioEnabled && currentNarrator) {
                currentNarrator.stop();
            }
            
            if (currentNarrator) {
                currentNarrator.isEnabled = globalAudioEnabled;
            }
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            initThreeJS();
            updateTemperatureDisplay();
            const narrator = createNewNarrator('initialization');
            narrator.speak('Welcome! Explore how temperature changes the state of matter. Use the slider or buttons to see ice, water, and steam. Try Activity 1.12 for the complete classroom experiment!');
        });

        // Handle resize
        window.addEventListener('resize', () => {
            const container = document.querySelector('.simulation-stage');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
    </script>
</body>
</html>