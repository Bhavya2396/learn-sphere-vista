<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matter in Our Surroundings - Interactive Chemistry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #8e44ad 50%, #764ba2 75%, #667eea 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(4px 4px at 20% 30%, rgba(255,255,255,0.2), transparent),
                radial-gradient(4px 4px at 60% 70%, rgba(255,255,255,0.2), transparent),
                radial-gradient(3px 3px at 80% 10%, rgba(255,255,255,0.3), transparent);
            background-size: 300px 300px;
            opacity: 0.5;
            animation: float 60s linear infinite;
            pointer-events: none;
        }

        @keyframes float {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(-300px, -300px) rotate(360deg); }
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .control-btn:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 3.5rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 0 0 40px rgba(255, 107, 107, 0.3);
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { 
                filter: brightness(1) drop-shadow(0 0 20px rgba(255, 107, 107, 0.5)); 
            }
            50% { 
                filter: brightness(1.2) drop-shadow(0 0 40px rgba(69, 183, 209, 0.7)); 
            }
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Matter Stage */
        .matter-stage {
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.9) 0%,
                rgba(118, 75, 162, 0.9) 50%,
                rgba(102, 126, 234, 0.9) 100%);
            border-radius: 25px;
            height: 600px;
            position: relative;
            margin: 40px 0;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 0 120px rgba(69, 183, 209, 0.2);
            overflow: hidden;
            border: 3px solid rgba(102, 126, 234, 0.4);
        }

        #matterCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #matterCanvas:active {
            cursor: grabbing;
        }

        /* Stage Info Overlay */
        .stage-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 2px solid rgba(102, 126, 234, 0.4);
            max-width: 320px;
        }

        .stage-info h3 {
            font-size: 1.3rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .stage-info p {
            font-size: 0.95rem;
            color: #e2e8f0;
            line-height: 1.5;
        }

        /* Experiment Display */
        .experiment-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 2px solid rgba(102, 126, 234, 0.4);
            font-size: 1.4rem;
            font-weight: bold;
            color: #4ecdc4;
            font-family: 'Courier New', monospace;
        }

        /* Scale Control */
        .scale-control {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(102, 126, 234, 0.4);
        }

        .scale-label {
            color: #a5b4fc;
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-align: center;
        }

        .scale-value {
            color: #fbbf24;
            font-weight: bold;
            text-align: center;
            font-size: 1.1rem;
        }

        /* Control Panel */
        .controls {
            text-align: center;
            margin: 40px 0;
        }

        .controls-title {
            font-size: 2rem;
            margin-bottom: 25px;
            background: linear-gradient(45deg, #667eea, #764ba2, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
        }

        .demo-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .demo-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 16px 28px;
            border-radius: 35px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            min-width: 180px;
            position: relative;
            overflow: hidden;
        }

        .demo-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .demo-btn:hover::before {
            left: 100%;
        }

        .demo-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
        }

        .demo-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            }
            50% { 
                box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
            }
        }

        /* Substance Selector */
        .substance-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .substance-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(102, 126, 234, 0.4);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .substance-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
            transform: scale(1.05);
        }

        .substance-btn.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        /* Info Panel */
        .info-panel {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.7),
                rgba(102, 126, 234, 0.7));
            border-radius: 25px;
            padding: 35px;
            margin: 35px 0;
            border: 3px solid rgba(102, 126, 234, 0.4);
            backdrop-filter: blur(15px);
        }

        .info-title {
            font-size: 1.8rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
        }

        /* Properties Grid */
        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .property-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .property-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .property-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .property-title {
            font-size: 1.1rem;
            color: #a5b4fc;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .property-value {
            font-size: 1.3rem;
            color: #fbbf24;
            font-weight: bold;
        }

        .property-description {
            font-size: 0.9rem;
            color: #cbd5e1;
            margin-top: 8px;
            line-height: 1.4;
        }

        /* Key Concepts */
        .key-concepts {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .concept-column {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            min-width: 200px;
            flex: 1;
        }

        .concept-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: bold;
            color: #4ecdc4;
        }

        .concept-content {
            font-size: 0.9rem;
            color: #cbd5e1;
            line-height: 1.5;
        }

        /* Progress Indicator */
        .progress-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: scale(1.3);
        }

        .progress-dot.completed {
            background: #10b981;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(102, 126, 234, 0.4);
        }

        .legend-title {
            font-size: 1rem;
            color: #a5b4fc;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .legend-items {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .legend-label {
            font-size: 0.9rem;
            color: #e2e8f0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .matter-stage {
                height: 400px;
            }
            
            .demo-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .properties-grid {
                grid-template-columns: 1fr;
            }
            
            .key-concepts {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">🔊</span>
            <span class="mute-icon">🔇</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Matter in Our Surroundings</h1>
            <p>Discover the fundamental nature of matter - from ancient Panch Tatva to modern particle theory. Everything around us is made of incredibly tiny particles!</p>
        </div>

        <!-- Matter Stage -->
        <div class="matter-stage" id="stage">
            <canvas id="matterCanvas"></canvas>
            
            <div class="stage-info" id="stageInfo">
                <h3 id="infoTitle">Nature of Matter</h3>
                <p id="infoText">Select a demonstration to explore matter's properties</p>
            </div>
            
            <div class="experiment-display" id="experimentDisplay">
                PARTICLE VIEW
            </div>

            <div class="scale-control">
                <div class="scale-label">Scale</div>
                <div class="scale-value" id="scaleValue">Molecular</div>
            </div>
            
            <div class="legend">
                <div class="legend-title">Particle Types</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #45b7d1;"></div>
                        <span class="legend-label">Water</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffffff;"></div>
                        <span class="legend-label">Salt</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff6b6b;"></div>
                        <span class="legend-label">KMnO₄</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-title" id="lesson-title">Explore Matter's Nature</div>
            
            <div class="demo-buttons">
                <button class="demo-btn" id="btn-complete" onclick="playCompleteLesson()">📚 Complete Lesson</button>
                <button class="demo-btn" id="btn-particle" onclick="showParticleNature()">⚛️ Particle Nature</button>
                <button class="demo-btn" id="btn-dissolution" onclick="showDissolution()">🧪 Dissolution</button>
                <button class="demo-btn" id="btn-dilution" onclick="showDilution()">💧 Dilution</button>
                <button class="demo-btn" id="btn-diffusion" onclick="showDiffusion()">🌊 Diffusion</button>
                <button class="demo-btn" id="btn-reset" onclick="resetAllClick()">🔄 Reset</button>
            </div>

            <div class="substance-selector">
                <button class="substance-btn selected" onclick="selectSubstance('salt')">Salt (NaCl)</button>
                <button class="substance-btn" onclick="selectSubstance('sugar')">Sugar (C₁₂H₂₂O₁₁)</button>
                <button class="substance-btn" onclick="selectSubstance('kmno4')">KMnO₄</button>
                <button class="substance-btn" onclick="selectSubstance('ink')">Ink</button>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="info-panel">
            <div class="info-title">🔬 Scientific Analysis</div>
            
            <!-- Properties Grid -->
            <div class="properties-grid">
                <div class="property-card">
                    <div class="property-icon">🧂</div>
                    <div class="property-title">Activity 1.1</div>
                    <div class="property-value" id="activity1">Dissolution</div>
                    <div class="property-description">Salt dissolves showing spaces between particles</div>
                </div>
                <div class="property-card">
                    <div class="property-icon">🔬</div>
                    <div class="property-title">Activity 1.2</div>
                    <div class="property-value" id="activity2">Dilution</div>
                    <div class="property-description">KMnO₄ shows particles are incredibly small</div>
                </div>
                <div class="property-card">
                    <div class="property-icon">🌊</div>
                    <div class="property-title">Particle Motion</div>
                    <div class="property-value" id="motion">Continuous</div>
                    <div class="property-description">Particles are always in motion</div>
                </div>
                <div class="property-card">
                    <div class="property-icon">🌌</div>
                    <div class="property-title">Particle Size</div>
                    <div class="property-value" id="size">Tiny</div>
                    <div class="property-description">Beyond imagination - millions in a crystal</div>
                </div>
            </div>

            <!-- Key Concepts -->
            <div class="key-concepts">
                <div class="concept-column">
                    <div class="concept-title">Ancient View</div>
                    <div class="concept-content">
                        • Panch Tatva (5 elements)<br>
                        • Air, Earth, Fire, Sky, Water<br>
                        • Everything made from these<br>
                        • Continuous matter theory
                    </div>
                </div>
                <div class="concept-column">
                    <div class="concept-title">Modern Science</div>
                    <div class="concept-content">
                        • Particulate nature<br>
                        • Incredibly small particles<br>
                        • Spaces between particles<br>
                        • Continuous motion
                    </div>
                </div>
                <div class="concept-column">
                    <div class="concept-title">Key Properties</div>
                    <div class="concept-content">
                        • Matter has mass<br>
                        • Occupies space<br>
                        • Made of particles<br>
                        • Particles attract each other
                    </div>
                </div>
            </div>

            <div id="current-info" style="text-align: center; margin-top: 20px; font-size: 1.1rem; color: #e2e8f0; line-height: 1.6;">
                Everything around us - air, water, food, even our bodies - is made of incredibly tiny particles that are constantly moving and have spaces between them!
            </div>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-indicator" id="progressIndicator" style="display: none;">
        <div class="progress-dot" data-step="1"></div>
        <div class="progress-dot" data-step="2"></div>
        <div class="progress-dot" data-step="3"></div>
        <div class="progress-dot" data-step="4"></div>
        <div class="progress-dot" data-step="5"></div>
    </div>

    <script>
        // Voice System with Proper Cleanup
        class MatterNarrator {
            constructor() {
                this.isEnabled = globalAudioEnabled;
                this.currentUtterance = null;
                this.settings = { rate: 0.9, pitch: 1.0, volume: 0.85 };
                this.isDestroyed = false;
            }

            async speak(text, delay = 0) {
                if (!this.isEnabled || !text || this.isDestroyed) return;
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        if (this.isDestroyed) {
                            resolve();
                            return;
                        }
                        this.stop();
                        const utterance = new SpeechSynthesisUtterance(text);
                        Object.assign(utterance, this.settings);
                        
                        utterance.onend = resolve;
                        utterance.onerror = resolve;
                        
                        this.currentUtterance = utterance;
                        speechSynthesis.speak(utterance);
                    }, delay);
                });
            }

            stop() {
                speechSynthesis.cancel();
                this.currentUtterance = null;
            }

            destroy() {
                this.isDestroyed = true;
                this.stop();
                this.currentUtterance = null;
                this.settings = null;
            }
        }

        // Global State Management
        let globalAudioEnabled = true;
        let currentNarrator = null;
        let isPlaying = false;
        let currentDemoAborted = false;
        let currentTaskId = null;
        let currentActiveButton = null;

        // Three.js variables
        let scene, camera, renderer;
        let waterParticles = [];
        let soluteParticles = [];
        let currentSubstance = 'salt';
        let animationId;
        let particleSystem = null;

        // Substance configurations
        const substanceConfigs = {
            salt: {
                name: 'Salt (NaCl)',
                color: 0xffffff,
                formula: 'NaCl',
                size: 0.15,
                dissolveTime: 3000
            },
            sugar: {
                name: 'Sugar (C₁₂H₂₂O₁₁)',
                color: 0xfff3cd,
                formula: 'C₁₂H₂₂O₁₁',
                size: 0.18,
                dissolveTime: 4000
            },
            kmno4: {
                name: 'Potassium Permanganate',
                color: 0xff6b6b,
                formula: 'KMnO₄',
                size: 0.12,
                dissolveTime: 2000
            },
            ink: {
                name: 'Ink',
                color: 0x000080,
                formula: 'Ink',
                size: 0.10,
                dissolveTime: 1500
            }
        };

        // Button Management Functions
        function setActiveButton(buttonId) {
            // Remove active class from all buttons
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to the specified button
            if (buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.classList.add('active');
                    currentActiveButton = buttonId;
                }
            }
        }

        // Stop Current Demo
        function stopCurrentDemo() {
            currentDemoAborted = true;
            currentTaskId = null;
            
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            
            hideProgress();
            isPlaying = false;
            
            // Remove active state from buttons after stop
            setTimeout(() => setActiveButton(null), 1000);
        }

        // Check if Demo Should Continue
        function shouldContinue(taskId = null) {
            if (taskId && currentTaskId && taskId !== currentTaskId) {
                return false;
            }
            return !currentDemoAborted;
        }

        // Create New Narrator
        function createNewNarrator(taskId = null) {
            if (currentNarrator) {
                currentNarrator.destroy();
                currentNarrator = null;
            }
            currentDemoAborted = false;
            currentTaskId = taskId;
            currentNarrator = new MatterNarrator();
            return currentNarrator;
        }

        // Initialize Three.js
        function initThreeJS() {
            const canvas = document.getElementById('matterCanvas');
            const container = document.getElementById('stage');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = null;
            
            // Camera
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(0, 0, 15);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(width, height);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            const backLight = new THREE.DirectionalLight(0x667eea, 0.4);
            backLight.position.set(-5, -5, -5);
            scene.add(backLight);
            
            // Create initial water particles
            createWaterSystem();
            
            // Setup controls
            setupMouseControls();
            
            // Start animation loop
            animate();
        }

        // Create water particle system
        function createWaterSystem() {
            clearParticles();
            
            particleSystem = new THREE.Group();
            
            const waterGeometry = new THREE.SphereGeometry(0.2, 16, 16);
            const waterMaterial = new THREE.MeshPhongMaterial({
                color: 0x45b7d1,
                emissive: 0x1e3c72,
                emissiveIntensity: 0.3,
                transparent: true,
                opacity: 0.8
            });
            
            // Create water molecules in beaker shape
            for (let i = 0; i < 200; i++) {
                const particle = new THREE.Mesh(waterGeometry, waterMaterial);
                
                // Position in a beaker-like shape
                const radius = Math.random() * 4 + 1;
                const angle = Math.random() * Math.PI * 2;
                const height = Math.random() * 6 - 3;
                
                particle.position.set(
                    Math.cos(angle) * radius,
                    height,
                    Math.sin(angle) * radius
                );
                
                particle.userData = {
                    originalPosition: particle.position.clone(),
                    velocity: new THREE.Vector3(
                        (Math.random() - 0.5) * 0.02,
                        (Math.random() - 0.5) * 0.02,
                        (Math.random() - 0.5) * 0.02
                    ),
                    isWater: true
                };
                
                waterParticles.push(particle);
                particleSystem.add(particle);
            }
            
            scene.add(particleSystem);
        }

        // Create solute particles
        function createSoluteParticles(count = 20) {
            const substance = substanceConfigs[currentSubstance];
            
            const soluteGeometry = new THREE.SphereGeometry(substance.size, 16, 16);
            const soluteMaterial = new THREE.MeshPhongMaterial({
                color: substance.color,
                emissive: substance.color,
                emissiveIntensity: 0.5
            });
            
            // Create crystals/granules at the top
            for (let i = 0; i < count; i++) {
                const particle = new THREE.Mesh(soluteGeometry, soluteMaterial);
                
                particle.position.set(
                    (Math.random() - 0.5) * 2,
                    4 + Math.random() * 2,
                    (Math.random() - 0.5) * 2
                );
                
                particle.userData = {
                    originalPosition: particle.position.clone(),
                    velocity: new THREE.Vector3(0, -0.05, 0),
                    dissolved: false,
                    dissolveProgress: 0,
                    targetOpacity: 1
                };
                
                soluteParticles.push(particle);
                particleSystem.add(particle);
            }
        }

        // Clear all particles
        function clearParticles() {
            if (particleSystem) {
                scene.remove(particleSystem);
            }
            waterParticles.forEach(particle => {
                if (particle.parent) particle.parent.remove(particle);
            });
            soluteParticles.forEach(particle => {
                if (particle.parent) particle.parent.remove(particle);
            });
            waterParticles = [];
            soluteParticles = [];
        }

        // Create beaker visualization
        function createBeaker() {
            const beakerGroup = new THREE.Group();
            
            // Beaker walls (transparent cylinder)
            const beakerGeometry = new THREE.CylinderGeometry(4.5, 4, 8, 32, 1, true);
            const beakerMaterial = new THREE.MeshPhongMaterial({
                color: 0xcccccc,
                transparent: true,
                opacity: 0.2,
                side: THREE.DoubleSide
            });
            const beaker = new THREE.Mesh(beakerGeometry, beakerMaterial);
            beaker.position.y = 0;
            beakerGroup.add(beaker);
            
            // Beaker bottom
            const bottomGeometry = new THREE.CircleGeometry(4, 32);
            const bottomMaterial = new THREE.MeshPhongMaterial({
                color: 0xcccccc,
                transparent: true,
                opacity: 0.3
            });
            const bottom = new THREE.Mesh(bottomGeometry, bottomMaterial);
            bottom.rotation.x = -Math.PI / 2;
            bottom.position.y = -4;
            beakerGroup.add(bottom);
            
            particleSystem.add(beakerGroup);
            return beakerGroup;
        }

        // Animate dissolution process
        async function animateDissolution() {
            return new Promise((resolve) => {
                if (!shouldContinue()) {
                    resolve();
                    return;
                }
                
                createSoluteParticles(15);
                
                let dissolvedCount = 0;
                const dissolutionAnimation = setInterval(() => {
                    if (!shouldContinue()) {
                        clearInterval(dissolutionAnimation);
                        resolve();
                        return;
                    }
                    
                    soluteParticles.forEach(particle => {
                        if (!particle.userData.dissolved) {
                            // Fall down
                            particle.position.add(particle.userData.velocity);
                            
                            // Check if hit water level
                            if (particle.position.y <= 3) {
                                particle.userData.dissolved = true;
                                particle.userData.velocity.set(
                                    (Math.random() - 0.5) * 0.03,
                                    (Math.random() - 0.5) * 0.03,
                                    (Math.random() - 0.5) * 0.03
                                );
                                dissolvedCount++;
                            }
                        } else {
                            // Spread throughout water
                            particle.position.add(particle.userData.velocity);
                            particle.userData.dissolveProgress += 0.02;
                            
                            if (particle.userData.dissolveProgress > 1) {
                                particle.material.opacity = Math.max(0.3, 1 - (particle.userData.dissolveProgress - 1) * 0.5);
                            }
                        }
                    });
                    
                    if (dissolvedCount >= soluteParticles.length && soluteParticles.length > 0) {
                        setTimeout(() => {
                            clearInterval(dissolutionAnimation);
                            resolve();
                        }, 2000);
                    }
                }, 50);
            });
        }

        // Animate dilution process
        async function animateDilution() {
            return new Promise((resolve) => {
                if (!shouldContinue()) {
                    resolve();
                    return;
                }
                
                let dilutionStep = 0;
                const maxSteps = 5;
                
                const dilutionAnimation = setInterval(() => {
                    if (!shouldContinue()) {
                        clearInterval(dilutionAnimation);
                        resolve();
                        return;
                    }
                    
                    dilutionStep++;
                    
                    // Reduce particle opacity and spread them out more
                    soluteParticles.forEach(particle => {
                        if (particle.userData.dissolved) {
                            const newOpacity = Math.max(0.1, particle.material.opacity * 0.7);
                            particle.material.opacity = newOpacity;
                            
                            // Increase spread
                            particle.userData.velocity.multiplyScalar(1.2);
                        }
                    });
                    
                    updateScaleValue(`1:${Math.pow(10, dilutionStep)}`);
                    
                    if (dilutionStep >= maxSteps) {
                        clearInterval(dilutionAnimation);
                        resolve();
                    }
                }, 1500);
            });
        }

        // Update particles based on their state
        function updateParticles() {
            // Update water particles
            waterParticles.forEach(particle => {
                if (particle.userData && particle.userData.velocity) {
                    particle.position.add(particle.userData.velocity);
                    
                    // Boundary check
                    if (Math.abs(particle.position.x) > 5 || Math.abs(particle.position.z) > 5) {
                        particle.userData.velocity.x *= -1;
                        particle.userData.velocity.z *= -1;
                    }
                    if (particle.position.y > 4 || particle.position.y < -4) {
                        particle.userData.velocity.y *= -1;
                    }
                }
            });
            
            // Update dissolved solute particles
            soluteParticles.forEach(particle => {
                if (particle.userData && particle.userData.dissolved && particle.userData.velocity) {
                    particle.position.add(particle.userData.velocity);
                    
                    // Boundary check
                    if (Math.abs(particle.position.x) > 6 || Math.abs(particle.position.z) > 6) {
                        particle.userData.velocity.x *= -1;
                        particle.userData.velocity.z *= -1;
                    }
                    if (particle.position.y > 5 || particle.position.y < -5) {
                        particle.userData.velocity.y *= -1;
                    }
                }
            });
        }

        // Setup mouse controls
        function setupMouseControls() {
            const canvas = renderer.domElement;
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging || !particleSystem) return;
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                particleSystem.rotation.y += deltaX * 0.01;
                particleSystem.rotation.x += deltaY * 0.01;
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(8, Math.min(25, camera.position.z));
            });
        }

        // Animation loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Update particles
            updateParticles();
            
            // Gentle rotation when not playing demos
            if (particleSystem && !isPlaying) {
                particleSystem.rotation.y += 0.003;
            }
            
            renderer.render(scene, camera);
        }

        // Complete Lesson
        async function playCompleteLesson() {
            const taskId = 'complete-lesson';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-complete');
            
            const narrator = createNewNarrator(taskId);
            await playCompleteLessonInternal(narrator, taskId);
            
            isPlaying = false;
            // Remove active state after completion
            setTimeout(() => setActiveButton(null), 2000);
        }

        async function playCompleteLessonInternal(narrator, taskId) {
            showProgress();
            
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("📚 Complete Matter in Our Surroundings Lesson");
            updateInfo("Introduction", "Journey into matter's nature");
            
            // Chapter 1: Ancient Knowledge
            updateProgress(1);
            await narrator.speak("Welcome to the fascinating world of matter! Since ancient times, humans have wondered about the nature of everything around us.");
            if (!shouldContinue(taskId)) return;
            
            await wait(1500);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Ancient Indian philosophers believed in the Panch Tatva - five basic elements: air, earth, fire, sky, and water.");
            if (!shouldContinue(taskId)) return;
            
            // Chapter 2: Modern Understanding
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            updateProgress(2);
            updateInfo("Modern Science", "Particles vs Continuous");
            
            await narrator.speak("Modern scientists discovered that matter is not continuous like a block of wood, but made of tiny particles!");
            if (!shouldContinue(taskId)) return;
            
            // Chapter 3: Dissolution Demo (Activity 1.1)
            await wait(1500);
            if (!shouldContinue(taskId)) return;
            updateProgress(3);
            updateInfo("Activity 1.1", "Salt dissolving in water");
            updateExperimentDisplay("DISSOLUTION");
            selectSubstance('salt');
            
            await narrator.speak("Let's perform Activity 1.1 from your textbook! We add salt to water and observe what happens.");
            if (!shouldContinue(taskId)) return;
            
            createBeaker();
            await animateDissolution();
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("The salt disappears but the water level doesn't change. This proves there are spaces between water particles where salt particles fit!");
            if (!shouldContinue(taskId)) return;
            
            // Chapter 4: Dilution Demo (Activity 1.2)
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            updateProgress(4);
            updateInfo("Activity 1.2", "How small are particles?");
            updateExperimentDisplay("DILUTION");
            
            selectSubstance('kmno4');
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("This is Activity 1.2! Even tiny crystals of potassium permanganate contain millions of particles.");
            if (!shouldContinue(taskId)) return;
            
            // Reset and start fresh dilution demo
            await resetAll();
            await wait(500);
            selectSubstance('kmno4');
            createBeaker();
            createSoluteParticles(10);
            await animateDissolution();
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Now watch as we dilute this solution multiple times. The color becomes lighter but never completely disappears!");
            if (!shouldContinue(taskId)) return;
            
            await animateDilution();
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Even after extreme dilution, millions of particles still remain! This shows particles are incredibly small - beyond our imagination!");
            if (!shouldContinue(taskId)) return;
            
            // Chapter 5: Diffusion Demo
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            updateProgress(5);
            updateInfo("Diffusion", "Particles spread on their own");
            updateExperimentDisplay("DIFFUSION");
            
            selectSubstance('ink');
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Finally, let's observe diffusion! Particles are in constant motion - watch how ink spreads in water without stirring.");
            if (!shouldContinue(taskId)) return;
            
            // Reset and start fresh diffusion demo
            await resetAll();
            await wait(500);
            selectSubstance('ink');
            createBeaker();
            createSoluteParticles(8);
            await animateDissolution();
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("This spreading happens because particles move constantly and randomly. This process is called diffusion!");
            if (!shouldContinue(taskId)) return;
            
            // Final Conclusion
            await wait(2000);
            if (!shouldContinue(taskId)) return;
            updateInfo("Conclusion", "Matter is particulate");
            updateExperimentDisplay("COMPLETE");
            
            await narrator.speak("These three experiments prove that matter is made of particles that are unimaginably small, with spaces between them, and in constant motion! This is the foundation of modern chemistry and physics.");
            
            hideProgress();
        }

        // Individual Demonstrations
        async function showParticleNature() {
            const taskId = 'particle-nature';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-particle');
            
            const narrator = createNewNarrator(taskId);
            await showParticleNatureInternal(narrator, taskId);
            
            isPlaying = false;
            // Keep button active until another is pressed
        }

        async function showParticleNatureInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("⚛️ Particulate Nature of Matter");
            updateInfo("Particle Theory", "Matter is made of particles");
            updateExperimentDisplay("PARTICLES");
            
            await narrator.speak("For centuries, scientists debated whether matter was continuous or made of particles. Modern science proves it's particulate!");
            if (!shouldContinue(taskId)) return;
            
            await wait(1000);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Look at these water molecules! Each one is incredibly tiny, but together they form the water we see and use every day.");
            if (!shouldContinue(taskId)) return;
            
            updateCurrentInfo("Everything around us - from the air we breathe to the food we eat - is made of countless tiny particles in constant motion.");
        }

        async function showDissolution() {
            const taskId = 'dissolution';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-dissolution');
            
            const narrator = createNewNarrator(taskId);
            await showDissolutionInternal(narrator, taskId);
            
            isPlaying = false;
            // Keep button active until another is pressed
        }

        async function showDissolutionInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🧪 Activity 1.1 - Dissolution Process");
            updateInfo("Activity 1.1", "Salt dissolving in water");
            updateExperimentDisplay("DISSOLUTION");
            
            await narrator.speak("Let's perform Activity 1.1 from your textbook! We add salt to water and observe what happens.");
            if (!shouldContinue(taskId)) return;
            
            createBeaker();
            await animateDissolution();
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("The salt disappears but the water level doesn't change. Salt particles occupy spaces between water molecules!");
            if (!shouldContinue(taskId)) return;
            
            updateCurrentInfo("Key Observation: Salt particles fit into spaces between water molecules, proving matter is particulate, not continuous.");
        }

        async function showDilution() {
            const taskId = 'dilution';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-dilution');
            
            const narrator = createNewNarrator(taskId);
            await showDilutionInternal(narrator, taskId);
            
            isPlaying = false;
            // Keep button active until another is pressed
        }

        async function showDilutionInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("💧 Activity 1.2 - Dilution Experiment");
            updateInfo("Activity 1.2", "Particles are incredibly small");
            updateExperimentDisplay("DILUTION");
            
            selectSubstance('kmno4');
            await wait(500);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("This is Activity 1.2! Even tiny crystals of potassium permanganate contain millions of particles.");
            if (!shouldContinue(taskId)) return;
            
            createSoluteParticles(10);
            await animateDissolution();
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Now watch as we dilute this solution multiple times. The color becomes lighter but never completely disappears!");
            if (!shouldContinue(taskId)) return;
            
            await animateDilution();
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Even after extreme dilution, millions of particles still remain visible!");
            
            updateCurrentInfo("Just one crystal contains millions of particles - they are small beyond our imagination!");
        }

        async function showDiffusion() {
            const taskId = 'diffusion';
            stopCurrentDemo();
            isPlaying = true;
            setActiveButton('btn-diffusion');
            
            const narrator = createNewNarrator(taskId);
            await showDiffusionInternal(narrator, taskId);
            
            isPlaying = false;
            // Keep button active until another is pressed
        }

        async function showDiffusionInternal(narrator, taskId) {
            await resetAll();
            if (!shouldContinue(taskId)) return;
            
            updateTitle("🌊 Diffusion Process");
            updateInfo("Diffusion", "Particles spread on their own");
            updateExperimentDisplay("DIFFUSION");
            
            selectSubstance('ink');
            await wait(500);
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("Particles are in constant motion! Watch how ink spreads in water without stirring.");
            if (!shouldContinue(taskId)) return;
            
            createSoluteParticles(5);
            await animateDissolution();
            if (!shouldContinue(taskId)) return;
            
            await narrator.speak("This spreading happens because particles move constantly and randomly. This is called diffusion!");
            if (!shouldContinue(taskId)) return;
            
            updateCurrentInfo("Diffusion proves that particles are always moving, even when we can't see them!");
        }

        // Helper Functions
        function selectSubstance(type) {
            currentSubstance = type;
            document.querySelectorAll('.substance-btn').forEach(btn => {
                const btnText = btn.textContent.toLowerCase();
                btn.classList.toggle('selected', 
                    btnText.includes(type) || 
                    (type === 'kmno4' && btnText.includes('kmno')) ||
                    (type === 'salt' && btnText.includes('nacl')) ||
                    (type === 'sugar' && btnText.includes('c₁₂')) ||
                    (type === 'ink' && btnText.includes('ink'))
                );
            });
        }

        async function resetAll() {
            if (currentNarrator) {
                currentNarrator.stop();
            }
            
            createWaterSystem();
            updateInfo("Nature of Matter", "Select a demonstration to explore matter's properties");
            updateCurrentInfo("Everything around us - air, water, food, even our bodies - is made of incredibly tiny particles that are constantly moving and have spaces between them!");
            updateScaleValue("Molecular");
            updateExperimentDisplay("PARTICLE VIEW");
            
            await wait(300);
        }

        async function resetAllClick() {
            stopCurrentDemo();
            isPlaying = false;
            setActiveButton('btn-reset');
            await resetAll();
            // Remove active state after reset
            setTimeout(() => setActiveButton(null), 1000);
        }

        function updateTitle(title) {
            document.getElementById('lesson-title').textContent = title;
        }

        function updateInfo(title, text) {
            document.getElementById('infoTitle').textContent = title;
            document.getElementById('infoText').textContent = text;
        }

        function updateCurrentInfo(text) {
            document.getElementById('current-info').textContent = text;
        }

        function updateScaleValue(value) {
            document.getElementById('scaleValue').textContent = value;
        }

        function updateExperimentDisplay(value) {
            document.getElementById('experimentDisplay').textContent = value;
        }

        function showProgress() {
            document.getElementById('progressIndicator').style.display = 'flex';
        }

        function hideProgress() {
            document.getElementById('progressIndicator').style.display = 'none';
        }

        function updateProgress(step) {
            document.querySelectorAll('.progress-dot').forEach((dot, index) => {
                if (index < step) {
                    dot.classList.add('completed');
                    dot.classList.remove('active');
                } else if (index === step - 1) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active', 'completed');
                }
            });
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Audio Control
        document.getElementById('mute-btn').addEventListener('click', () => {
            globalAudioEnabled = !globalAudioEnabled;
            document.getElementById('mute-btn').classList.toggle('muted', !globalAudioEnabled);
            
            if (!globalAudioEnabled && currentNarrator) {
                currentNarrator.stop();
            }
            
            if (currentNarrator) {
                currentNarrator.isEnabled = globalAudioEnabled;
            }
        });

        // Initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        function initialize() {
            initThreeJS();
            const narrator = createNewNarrator('initialization');
            narrator.speak("Welcome to Matter in Our Surroundings! Discover how everything around us is made of incredibly tiny particles. From ancient wisdom to modern science - explore the fundamental nature of matter!");
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const container = document.getElementById('stage');
            if (camera && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        });
    </script>
</body>
</html>