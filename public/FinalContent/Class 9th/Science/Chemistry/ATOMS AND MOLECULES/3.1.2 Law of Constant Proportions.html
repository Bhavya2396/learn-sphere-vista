<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 3.1.2 - Law of Constant Proportions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Law Box */
        .law-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .law-title {
            font-size: 1.4rem;
            color: #ffd89b;
            margin-bottom: 10px;
        }

        .law-content {
            font-size: 1.1rem;
            font-style: italic;
            line-height: 1.6;
        }

        /* Animation Stage */
        .animation-stage {
            background: linear-gradient(135deg, rgba(0, 0, 20, 0.9), rgba(20, 0, 40, 0.9));
            border-radius: 20px;
            padding: 20px;
            margin: 30px 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            min-height: 500px;
            position: relative;
            display: flex;
            gap: 20px;
        }

        .canvas-container {
            flex: 1;
            height: 500px;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
        }

        #mainCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Atom Legend */
        .atom-legend {
            width: 200px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .legend-table {
            width: 100%;
        }

        .legend-row {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        .legend-row:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 15px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .legend-label {
            font-size: 1rem;
            color: #ffffff;
            font-weight: 500;
        }

        /* Dalton Animation Stages */
        .dalton-stage {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 10px;
            display: none;
            backdrop-filter: blur(10px);
            max-width: 600px;
            text-align: center;
        }

        .dalton-stage h3 {
            color: #ffd89b;
            margin-bottom: 5px;
            font-size: 1.2rem;
        }

        .dalton-stage p {
            color: #e0e0e0;
            font-size: 0.95rem;
        }

        /* Info Display */
        .info-display {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
        }

        .info-title {
            font-size: 1.2rem;
            color: #4ecdc4;
            margin-bottom: 5px;
        }

        .info-text {
            font-size: 0.95rem;
            color: #e0e0e0;
        }

        /* Ratio Display */
        .ratio-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .ratio-title {
            font-size: 1.1rem;
            color: #ffd89b;
            margin-bottom: 10px;
            text-align: center;
        }

        .ratio-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .ratio-element {
            color: #ff6b6b;
            font-weight: bold;
        }

        .ratio-value {
            color: #45b7d1;
        }

        /* Controls */
        .controls {
            text-align: center;
            margin: 30px 0;
        }

        .controls-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #ffd89b;
        }

        .demo-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .demo-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .demo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .demo-btn.active {
            background: linear-gradient(135deg, #ffd89b, #19547b);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 216, 155, 0.4);
            animation: pulse 1.5s infinite;
        }

        .demo-btn.loading {
            background: linear-gradient(135deg, #667eea, #764ba2);
            position: relative;
            overflow: hidden;
        }

        .demo-btn.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: loadingShimmer 1.5s infinite;
        }

        .demo-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 6px 20px rgba(255, 216, 155, 0.4);
            }
            50% {
                box-shadow: 0 6px 30px rgba(255, 216, 155, 0.6);
            }
            100% {
                box-shadow: 0 6px 20px rgba(255, 216, 155, 0.4);
            }
        }

        @keyframes loadingShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Data Panel */
        .data-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }

        /* Progress Bar */
        .progress-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            display: none !important;
            z-index: 1000;
            min-width: 300px;
        }

        .progress-title {
            color: #4ecdc4;
            font-size: 1.1rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #45b7d1);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: #e0e0e0;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 8px;
        }

        .data-title {
            font-size: 1.5rem;
            text-align: center;
            color: #4ecdc4;
            margin-bottom: 20px;
        }

        .mass-calculation {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .calc-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .calc-label {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .calc-value {
            font-size: 1.8rem;
            color: #4ecdc4;
            font-weight: bold;
        }

        /* Dalton's Postulates */
        .postulates-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            display: none;
        }

        .postulates-title {
            font-size: 1.5rem;
            color: #ff6b6b;
            margin-bottom: 20px;
            text-align: center;
        }

        .postulate-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #4ecdc4;
        }

        .postulate-number {
            color: #4ecdc4;
            font-weight: bold;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .demo-buttons { flex-direction: column; }
            .mass-calculation { grid-template-columns: 1fr; }
            .animation-stage { 
                flex-direction: column; 
                height: auto;
            }
            .canvas-container { 
                width: 100%; 
                margin-bottom: 20px;
            }
            .atom-legend { 
                width: 100%; 
                display: flex;
                flex-direction: column;
            }
            .legend-table {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">🔊</span>
            <span class="mute-icon">🔇</span>
        </button>
        <button id="speed-btn" class="control-btn">1x</button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>3.1.2 Law of Constant Proportions</h1>
            <p>Discover how elements combine in fixed ratios to form compounds</p>
        </div>

        <!-- Law Box -->
        <div class="law-box">
            <div class="law-title">⚖️ Proust's Law</div>
            <div class="law-content">
                "In a chemical substance the elements are always present in definite proportions by mass"
            </div>
        </div>

        <!-- Animation Stage -->
        <div class="animation-stage">
            <div class="canvas-container">
                <canvas id="mainCanvas"></canvas>
                
                <div class="info-display" id="infoDisplay">
                    <div class="info-title" id="infoTitle">Law of Constant Proportions</div>
                    <div class="info-text" id="infoText">Elements combine in fixed mass ratios</div>
                </div>

                <div class="ratio-display" id="ratioDisplay">
                    <div class="ratio-title">Mass Ratio</div>
                    <div id="ratioContent"></div>
                </div>
                
                <div class="dalton-stage" id="daltonStage">
                    <h3 id="daltonTitle">Postulate</h3>
                    <p id="daltonText">Description</p>
                </div>
            </div>
            
            <!-- Atom Legend -->
            <div class="atom-legend" id="atomLegend" style="display: none;">
                <div class="legend-table" id="legendTable">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-title">Explore the Concepts</div>
            <div class="demo-buttons">
                <button class="demo-btn" id="completeBtn" onclick="handleButtonClick(this, 'completeBtn', playCompleteLesson)">📖 Complete Lesson</button>
                <button class="demo-btn" id="waterBtn" onclick="handleButtonClick(this, 'waterBtn', showWater)">💧 Water (H₂O)</button>
                <button class="demo-btn" id="ammoniaBtn" onclick="handleButtonClick(this, 'ammoniaBtn', showAmmonia)">⚗️ Ammonia (NH₃)</button>
                <button class="demo-btn" id="daltonBtn" onclick="handleButtonClick(this, 'daltonBtn', showDalton)">⚛️ Dalton's Theory</button>
                <button class="demo-btn" id="resetBtn" onclick="handleButtonClick(this, 'resetBtn', resetAll)">🔄 Reset</button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-title" id="progressTitle">Complete Lesson Progress</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Step 1 of 6</div>
        </div>

        <!-- Data Panel -->
        <div class="data-panel">
            <div class="data-title">📊 Mass Proportions Analysis</div>
            <div class="mass-calculation">
                <div class="calc-card">
                    <div class="calc-label">Element 1</div>
                    <div class="calc-value" id="element1">-</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">Element 2</div>
                    <div class="calc-value" id="element2">-</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">Compound</div>
                    <div class="calc-value" id="compound">-</div>
                </div>
                <div class="calc-card">
                    <div class="calc-label">Mass Ratio</div>
                    <div class="calc-value" id="ratio">-</div>
                </div>
            </div>
        </div>

        <!-- Dalton's Postulates -->
        <div class="postulates-container" id="postulatesContainer">
            <div class="postulates-title">Dalton's Atomic Theory Postulates</div>
            <div id="postulatesList"></div>
        </div>
    </div>

    <script>
        // Initialize Three.js
        let scene, camera, renderer;
        let molecules = [];
        let atoms = [];
        let isAnimating = false;
        let animationId;
        let currentInterval = null;
        let currentTimeouts = [];
        let activeButton = null;
        let isTransitioning = false;
        let isCompleteLessonRunning = false;
        let currentLessonStep = 0;
        let totalLessonSteps = 6;

        // Narrator system
        class Narrator {
            constructor() {
                this.isEnabled = true;
                this.rate = 1.0;
            }

            async speak(text, delay = 0) {
                if (!this.isEnabled || !text) return Promise.resolve();
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        speechSynthesis.cancel();
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.rate = this.rate;
                        utterance.pitch = 1.0;
                        utterance.volume = 0.85;
                        utterance.onend = resolve;
                        utterance.onerror = resolve;
                        speechSynthesis.speak(utterance);
                    }, delay);
                });
            }

            stop() {
                speechSynthesis.cancel();
            }

            setSpeed(speed) {
                this.rate = speed;
            }
        }

        const narrator = new Narrator();

        // Atomic data
        const atomicData = {
            H: { color: 0xffffff, radius: 0.5, mass: 1, name: 'Hydrogen' },
            O: { color: 0xff0000, radius: 0.8, mass: 16, name: 'Oxygen' },
            N: { color: 0x0000ff, radius: 0.7, mass: 14, name: 'Nitrogen' },
            C: { color: 0x333333, radius: 0.7, mass: 12, name: 'Carbon' }
        };

        function init() {
            console.log("Initializing Three.js...");
            
            // Scene setup
            scene = new THREE.Scene();
            
            const canvas = document.getElementById('mainCanvas');
            const container = canvas.parentElement;
            
            console.log("Canvas found:", canvas);
            console.log("Container dimensions:", container.clientWidth, "x", container.clientHeight);
            
            // Camera
            camera = new THREE.PerspectiveCamera(
                60, 
                container.clientWidth / container.clientHeight, 
                0.1, 
                1000
            );
            camera.position.set(0, 5, 15);
            camera.lookAt(0, 0, 0);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            console.log("Renderer created and configured");
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 10);
            scene.add(directionalLight);
            
            const pointLight = new THREE.PointLight(0x764ba2, 0.5);
            pointLight.position.set(-10, 10, -10);
            scene.add(pointLight);
            
            // Mouse controls
            setupMouseControls();
            
            // Start animation loop
            animate();
        }

        function createAtom(element, position = {x: 0, y: 0, z: 0}) {
            const data = atomicData[element];
            const group = new THREE.Group();
            
            // Create nucleus sphere only
            const geometry = new THREE.SphereGeometry(data.radius, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: data.color,
                shininess: 100,
                specular: 0xffffff,
                emissive: data.color,
                emissiveIntensity: 0.1
            });
            
            const nucleus = new THREE.Mesh(geometry, material);
            group.add(nucleus);
            
            group.position.set(position.x, position.y, position.z);
            group.userData = { element: element };
            
            return group;
        }

        function createBond(pos1, pos2) {
            const distance = Math.sqrt(
                Math.pow(pos2.x - pos1.x, 2) +
                Math.pow(pos2.y - pos1.y, 2) +
                Math.pow(pos2.z - pos1.z, 2)
            );
            
            const geometry = new THREE.CylinderGeometry(0.1, 0.1, distance, 8);
            const material = new THREE.MeshPhongMaterial({
                color: 0xcccccc
            });
            
            const bond = new THREE.Mesh(geometry, material);
            bond.position.set(
                (pos1.x + pos2.x) / 2,
                (pos1.y + pos2.y) / 2,
                (pos1.z + pos2.z) / 2
            );
            
            const direction = new THREE.Vector3(
                pos2.x - pos1.x,
                pos2.y - pos1.y,
                pos2.z - pos1.z
            ).normalize();
            
            bond.lookAt(new THREE.Vector3(
                bond.position.x + direction.x,
                bond.position.y + direction.y,
                bond.position.z + direction.z
            ));
            bond.rotateX(Math.PI / 2);
            
            return bond;
        }

        function clearScene() {
            // Remove all objects except lights
            const toRemove = [];
            scene.traverse(child => {
                if (child.type === 'Mesh' || child.type === 'Group') {
                    toRemove.push(child);
                }
            });
            
            toRemove.forEach(child => {
                if (child.geometry) child.geometry.dispose();
                if (child.material) child.material.dispose();
                scene.remove(child);
            });
            
            molecules = [];
            atoms = [];
        }

        // Function to update legend based on animation
        function updateLegend(elements) {
            const legend = document.getElementById('atomLegend');
            const legendTable = document.getElementById('legendTable');
            
            if (!elements || elements.length === 0) {
                legend.style.display = 'none';
                return;
            }
            
            legendTable.innerHTML = '';
            elements.forEach(el => {
                const row = document.createElement('div');
                row.className = 'legend-row';
                row.innerHTML = `
                    <div class="legend-color" style="background: ${el.color};"></div>
                    <div class="legend-label">${el.label}</div>
                `;
                legendTable.appendChild(row);
            });
            
            legend.style.display = 'block';
        }

        // New button handling function
        async function handleButtonClick(button, buttonId, functionToCall) {
            // If complete lesson is running and user clicks a different button, stop it
            if (isCompleteLessonRunning && buttonId !== 'completeBtn') {
                await stopCompleteLesson();
            }
            
            // If user clicks complete lesson while another animation is running, stop it
            if (buttonId === 'completeBtn' && (isAnimating || isTransitioning)) {
                await stopAllAnimations();
            }
            
            // If any animation is running and user clicks a different button, stop it
            if ((isAnimating || isTransitioning) && buttonId !== 'resetBtn') {
                await stopAllAnimations();
            }
            
            // Call the original activateButton function
            await activateButton(button);
            
            // Call the specific function
            await functionToCall();
        }

        // Button activation function for visual feedback
        async function activateButton(button) {
            // First, stop any current animations and narration
            await stopAllAnimations();
            
            // Remove active and loading classes from all buttons
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.classList.remove('active', 'loading');
            });
            
            // Add loading class to clicked button
            button.classList.add('loading');
            
            // Add click animation
            gsap.to(button, {
                duration: 0.1,
                scale: 0.95,
                yoyo: true,
                repeat: 1,
                ease: "power2.inOut",
                onComplete: () => {
                    // Remove loading class and add active class
                    button.classList.remove('loading');
                    button.classList.add('active');
                }
            });
        }

        // Function to set active button
        function setActiveButton(buttonId) {
            // Remove active class from all buttons
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.classList.remove('active', 'loading');
            });
            
            // Add active class to current button
            if (buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) btn.classList.add('active');
                activeButton = buttonId;
            }
        }

        // Progress management functions
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function updateProgress(step) {
            currentLessonStep = step;
            const percentage = (step / totalLessonSteps) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `Step ${step} of ${totalLessonSteps}`;
        }

        function updateProgressTitle(title) {
            document.getElementById('progressTitle').textContent = title;
        }

        // Stop complete lesson function
        async function stopCompleteLesson() {
            isCompleteLessonRunning = false;
            isAnimating = false;
            hideProgress();
            await stopAllAnimations();
            setActiveButton(null);
        }

        // Stop all animations and clean up
        async function stopAllAnimations() {
            // Set transitioning flag to prevent overlapping
            isTransitioning = true;
            
            // Stop narrator
            narrator.stop();
            
            // Kill all GSAP animations
            gsap.killTweensOf("*");
            
            // Clear any running intervals
            if (currentInterval) {
                clearInterval(currentInterval);
                currentInterval = null;
            }
            
            // Clear any running timeouts
            currentTimeouts.forEach(timeout => clearTimeout(timeout));
            currentTimeouts = [];
            
            // Stop animation flag
            isAnimating = false;
            
            // Small delay to ensure cleanup
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Clear transitioning flag
            isTransitioning = false;
        }

        // Auto-reset and prepare function for control buttons
        async function autoResetAndPrepare() {
            // Stop all animations first
            await stopAllAnimations();
            
            // Clear the scene
            clearScene();
            
            // Reset all UI elements
            document.getElementById('ratioDisplay').style.display = 'none';
            document.getElementById('postulatesContainer').style.display = 'none';
            document.getElementById('daltonStage').style.display = 'none';
            document.getElementById('atomLegend').style.display = 'none';
            
            // Reset mass data display
            updateMassData('Element 1', '-', 'Element 2', '-', 'Compound', '-', '-');
            
            // Reset info display
            updateInfo("Preparing...", "Loading content...");
            
            // Reset camera position
            if (camera) {
                gsap.set(camera.position, { x: 0, y: 5, z: 15 });
                camera.lookAt(0, 0, 0);
            }
            
            // Reset scene rotation
            if (scene) {
                gsap.set(scene.rotation, { x: 0, y: 0, z: 0 });
            }
            
            // Reset demo buttons
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.classList.remove('active', 'loading');
            });
            
            // Small delay to ensure smooth transition
            await new Promise(resolve => setTimeout(resolve, 300));
        }

        // Water demonstration
        async function showWater() {
            // Auto-reset and prepare for water demonstration
            await autoResetAndPrepare();
            
            updateInfo("Water Formation", "H₂O - Mass ratio H:O = 1:8");
            
            // Show legend for water
            updateLegend([
                { color: '#ffffff', label: 'Hydrogen (H)' },
                { color: '#ff0000', label: 'Oxygen (O)' }
            ]);
            
            const molecule = new THREE.Group();
            
            // Create atoms
            const oxygen = createAtom('O', {x: 0, y: 0, z: 0});
            const hydrogen1 = createAtom('H', {x: -2, y: -1, z: 0});
            const hydrogen2 = createAtom('H', {x: 2, y: -1, z: 0});
            
            molecule.add(oxygen);
            molecule.add(hydrogen1);
            molecule.add(hydrogen2);
            
            // Create bonds
            molecule.add(createBond(oxygen.position, hydrogen1.position));
            molecule.add(createBond(oxygen.position, hydrogen2.position));
            
            scene.add(molecule);
            molecules.push(molecule);
            
            // Animate assembly
            gsap.from(oxygen.position, {
                duration: 1.5,
                y: 5,
                ease: "power2.out"
            });
            
            gsap.from(hydrogen1.position, {
                duration: 1.5,
                x: -6,
                delay: 0.5,
                ease: "power2.out"
            });
            
            gsap.from(hydrogen2.position, {
                duration: 1.5,
                x: 6,
                delay: 0.5,
                ease: "power2.out"
            });
            
            // Show ratio
            showRatio([
                { element: 'Hydrogen', value: '2 g' },
                { element: 'Oxygen', value: '16 g' },
                { element: 'Ratio', value: '1:8' }
            ]);
            
            updateMassData('Hydrogen', '2g', 'Oxygen', '16g', 'H₂O', '18g', '1:8');
            
            await narrator.speak("Water always forms with hydrogen and oxygen in a 1 to 8 mass ratio.");
        }

        // Water demonstration content (without auto-reset)
        async function showWaterContent() {
            clearScene();
            updateInfo("Water Formation", "H₂O - Mass ratio H:O = 1:8");
            
            // Show legend for water
            updateLegend([
                { color: '#ffffff', label: 'Hydrogen (H)' },
                { color: '#ff0000', label: 'Oxygen (O)' }
            ]);
            
            const molecule = new THREE.Group();
            
            // Create atoms
            const oxygen = createAtom('O', {x: 0, y: 0, z: 0});
            const hydrogen1 = createAtom('H', {x: -2, y: -1, z: 0});
            const hydrogen2 = createAtom('H', {x: 2, y: -1, z: 0});
            
            molecule.add(oxygen);
            molecule.add(hydrogen1);
            molecule.add(hydrogen2);
            
            // Create bonds
            molecule.add(createBond(oxygen.position, hydrogen1.position));
            molecule.add(createBond(oxygen.position, hydrogen2.position));
            
            scene.add(molecule);
            molecules.push(molecule);
            
            // Animate assembly
            gsap.from(oxygen.position, {
                duration: 1.5,
                y: 5,
                ease: "power2.out"
            });
            
            gsap.from(hydrogen1.position, {
                duration: 1.5,
                x: -6,
                delay: 0.5,
                ease: "power2.out"
            });
            
            gsap.from(hydrogen2.position, {
                duration: 1.5,
                x: 6,
                delay: 0.5,
                ease: "power2.out"
            });
            
            // Show ratio
            showRatio([
                { element: 'Hydrogen', value: '2 g' },
                { element: 'Oxygen', value: '16 g' },
                { element: 'Ratio', value: '1:8' }
            ]);
            
            updateMassData('Hydrogen', '2g', 'Oxygen', '16g', 'H₂O', '18g', '1:8');
        }

        // Ammonia demonstration
        async function showAmmonia() {
            // Auto-reset and prepare for ammonia demonstration
            await autoResetAndPrepare();
            
            updateInfo("Ammonia Formation", "NH₃ - Mass ratio N:H = 14:3");
            
            // Show legend for ammonia
            updateLegend([
                { color: '#0000ff', label: 'Nitrogen (N)' },
                { color: '#ffffff', label: 'Hydrogen (H)' }
            ]);
            
            const molecule = new THREE.Group();
            
            // Create atoms
            const nitrogen = createAtom('N', {x: 0, y: 0, z: 0});
            const h1 = createAtom('H', {x: 0, y: -2, z: 2});
            const h2 = createAtom('H', {x: 1.7, y: -2, z: -1});
            const h3 = createAtom('H', {x: -1.7, y: -2, z: -1});
            
            molecule.add(nitrogen);
            molecule.add(h1);
            molecule.add(h2);
            molecule.add(h3);
            
            // Create bonds
            molecule.add(createBond(nitrogen.position, h1.position));
            molecule.add(createBond(nitrogen.position, h2.position));
            molecule.add(createBond(nitrogen.position, h3.position));
            
            scene.add(molecule);
            molecules.push(molecule);
            
            // Animate
            gsap.from(molecule.scale, {
                duration: 1.5,
                x: 0, y: 0, z: 0,
                ease: "back.out(1.7)"
            });
            
            // Show ratio
            showRatio([
                { element: 'Nitrogen', value: '14 g' },
                { element: 'Hydrogen', value: '3 g' },
                { element: 'Ratio', value: '14:3' }
            ]);
            
            updateMassData('Nitrogen', '14g', 'Hydrogen', '3g', 'NH₃', '17g', '14:3');
            
            await narrator.speak("Ammonia always has nitrogen and hydrogen in a 14 to 3 mass ratio.");
        }

        // Ammonia demonstration content (without auto-reset)
        async function showAmmoniaContent() {
            clearScene();
            updateInfo("Ammonia Formation", "NH₃ - Mass ratio N:H = 14:3");
            
            // Show legend for ammonia
            updateLegend([
                { color: '#0000ff', label: 'Nitrogen (N)' },
                { color: '#ffffff', label: 'Hydrogen (H)' }
            ]);
            
            const molecule = new THREE.Group();
            
            // Create atoms
            const nitrogen = createAtom('N', {x: 0, y: 0, z: 0});
            const h1 = createAtom('H', {x: 0, y: -2, z: 2});
            const h2 = createAtom('H', {x: 1.7, y: -2, z: -1});
            const h3 = createAtom('H', {x: -1.7, y: -2, z: -1});
            
            molecule.add(nitrogen);
            molecule.add(h1);
            molecule.add(h2);
            molecule.add(h3);
            
            // Create bonds
            molecule.add(createBond(nitrogen.position, h1.position));
            molecule.add(createBond(nitrogen.position, h2.position));
            molecule.add(createBond(nitrogen.position, h3.position));
            
            scene.add(molecule);
            molecules.push(molecule);
            
            // Animate
            gsap.from(molecule.scale, {
                duration: 1.5,
                x: 0, y: 0, z: 0,
                ease: "back.out(1.7)"
            });
            
            // Show ratio
            showRatio([
                { element: 'Nitrogen', value: '14 g' },
                { element: 'Hydrogen', value: '3 g' },
                { element: 'Ratio', value: '14:3' }
            ]);
            
            updateMassData('Nitrogen', '14g', 'Hydrogen', '3g', 'NH₃', '17g', '14:3');
        }

        // Dalton's theory with creative animations
        async function showDalton() {
            await autoResetAndPrepare();
            updateInfo("Dalton's Atomic Theory", "Foundation of modern chemistry");
            updateLegend([]);
            
            // Set animation flag
            isAnimating = true;
            
            const postulates = [
                { 
                    title: "Matter is Made of Atoms", 
                    desc: "All matter consists of tiny indivisible particles called atoms",
                    narration: "First postulate: All matter is made of extremely small particles called atoms. Watch as this solid matter breaks down into its fundamental atomic components."
                },
                { 
                    title: "Atoms are Indivisible", 
                    desc: "Atoms cannot be created or destroyed in chemical reactions",
                    narration: "Second postulate: Atoms are indivisible and cannot be destroyed. Notice how the atom resists all attempts to break it apart."
                },
                { 
                    title: "Identical Atoms", 
                    desc: "All atoms of the same element are identical in mass and properties",
                    narration: "Third postulate: All atoms of the same element are identical. These oxygen atoms all have the same properties."
                },
                { 
                    title: "Different Elements", 
                    desc: "Atoms of different elements have different masses and properties",
                    narration: "Fourth postulate: Atoms of different elements are different. Each element has unique characteristics."
                },
                { 
                    title: "Whole Number Ratios", 
                    desc: "Atoms combine in simple whole number ratios to form compounds",
                    narration: "Fifth postulate: Atoms combine in simple whole number ratios. Water always forms from 2 hydrogen and 1 oxygen atom."
                },
                { 
                    title: "Constant Composition", 
                    desc: "The composition of a compound is always the same",
                    narration: "Sixth postulate: A compound always has the same composition, regardless of its source."
                }
            ];
            
            // Show postulates container
            const container = document.getElementById('postulatesContainer');
            const list = document.getElementById('postulatesList');
            list.innerHTML = '';
            
            postulates.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'postulate-item';
                div.innerHTML = `<span class="postulate-number">${i+1}.</span>${item.desc}`;
                list.appendChild(div);
                
                gsap.from(div, {
                    duration: 0.5,
                    opacity: 0,
                    x: -50,
                    delay: i * 0.2
                });
            });
            
            container.style.display = 'block';
            const daltonStage = document.getElementById('daltonStage');
            
            // Helper functions for animations
            function createMatterBreakdown() {
                const geometry = new THREE.BoxGeometry(4, 4, 4);
                const material = new THREE.MeshPhongMaterial({
                    color: 0x9333ea,
                    transparent: true,
                    opacity: 0.7
                });
                const cube = new THREE.Mesh(geometry, material);
                scene.add(cube);
                
                gsap.to(cube.scale, {
                    duration: 2,
                    x: 0.1,
                    y: 0.1,
                    z: 0.1,
                    ease: "power2.in",
                    onComplete: () => {
                        scene.remove(cube);
                        for (let i = 0; i < 20; i++) {
                            const atom = createAtom('H', {
                                x: (Math.random() - 0.5) * 10,
                                y: (Math.random() - 0.5) * 6,
                                z: (Math.random() - 0.5) * 10
                            });
                            scene.add(atom);
                            atoms.push(atom);
                            
                            gsap.from(atom.scale, {
                                duration: 1,
                                x: 0, y: 0, z: 0,
                                delay: i * 0.05,
                                ease: "back.out(1.7)"
                            });
                        }
                    }
                });
            }
            
            function createIndivisibleDemo() {
                const atom = createAtom('O', {x: 0, y: 0, z: 0});
                atom.scale.set(3, 3, 3);
                scene.add(atom);
                
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    const lineGeometry = new THREE.CylinderGeometry(0.05, 0.2, 3, 8);
                    const lineMaterial = new THREE.MeshBasicMaterial({ 
                        color: 0xffff00,
                        emissive: 0xffff00 
                    });
                    const line = new THREE.Mesh(lineGeometry, lineMaterial);
                    line.position.set(
                        Math.cos(angle) * 5,
                        0,
                        Math.sin(angle) * 5
                    );
                    line.lookAt(0, 0, 0);
                    line.rotateX(Math.PI / 2);
                    scene.add(line);
                    
                    gsap.to(line.position, {
                        duration: 1,
                        x: Math.cos(angle) * 1.5,
                        z: Math.sin(angle) * 1.5,
                        ease: "power2.in",
                        repeat: 3,
                        yoyo: true
                    });
                }
                
                gsap.to(atom.scale, {
                    duration: 0.2,
                    x: 2.8,
                    y: 2.8,
                    z: 2.8,
                    repeat: 6,
                    yoyo: true,
                    ease: "elastic.out(1, 0.3)"
                });
            }
            
            function createIdenticalAtomsDemo() {
                for (let i = 0; i < 6; i++) {
                    const angle = (i / 6) * Math.PI * 2;
                    const atom = createAtom('O', {
                        x: Math.cos(angle) * 4,
                        y: 0,
                        z: Math.sin(angle) * 4
                    });
                    scene.add(atom);
                    
                    gsap.from(atom.position, {
                        duration: 1,
                        y: 5,
                        delay: i * 0.1,
                        ease: "bounce.out"
                    });
                    
                    gsap.to(atom.rotation, {
                        duration: 4,
                        y: Math.PI * 2,
                        repeat: -1,
                        ease: "none"
                    });
                }
            }
            
            function createDifferentElementsDemo() {
                const elements = ['H', 'O', 'N', 'C'];
                const positions = [
                    {x: -4, y: 0, z: 0},
                    {x: -1.5, y: 0, z: 0},
                    {x: 1.5, y: 0, z: 0},
                    {x: 4, y: 0, z: 0}
                ];
                
                elements.forEach((el, i) => {
                    const atom = createAtom(el, positions[i]);
                    scene.add(atom);
                    
                    const scale = atomicData[el].radius * 1.5;
                    atom.scale.set(scale, scale, scale);
                    
                    gsap.from(atom.position, {
                        duration: 1,
                        y: -5,
                        delay: i * 0.2,
                        ease: "elastic.out(1, 0.5)"
                    });
                    
                    gsap.to(atom.rotation, {
                        duration: 2 + i,
                        y: Math.PI * 2,
                        repeat: -1,
                        ease: "none"
                    });
                });
            }
            
            async function createRatioDemo() {
                const oxygen = createAtom('O', {x: 0, y: 0, z: 0});
                const h1 = createAtom('H', {x: -3, y: 0, z: 0});
                const h2 = createAtom('H', {x: 3, y: 0, z: 0});
                
                scene.add(oxygen);
                scene.add(h1);
                scene.add(h2);
                
                await new Promise(resolve => {
                    gsap.to(h1.position, {
                        duration: 2,
                        x: -1.5,
                        y: -1,
                        ease: "power2.inOut",
                        onComplete: () => {
                            const bond1 = createBond(oxygen.position, h1.position);
                            scene.add(bond1);
                        }
                    });
                    
                    gsap.to(h2.position, {
                        duration: 2,
                        x: 1.5,
                        y: -1,
                        ease: "power2.inOut",
                        onComplete: () => {
                            const bond2 = createBond(oxygen.position, h2.position);
                            scene.add(bond2);
                            resolve();
                        }
                    });
                });
                
                showRatio([
                    { element: 'Hydrogen atoms', value: '2' },
                    { element: 'Oxygen atoms', value: '1' },
                    { element: 'Ratio', value: '2:1' }
                ]);
            }
            
            function createConstantCompositionDemo() {
                for (let i = 0; i < 3; i++) {
                    const group = new THREE.Group();
                    
                    const o = createAtom('O', {x: 0, y: 0, z: 0});
                    const h1 = createAtom('H', {x: -1.2, y: -0.8, z: 0});
                    const h2 = createAtom('H', {x: 1.2, y: -0.8, z: 0});
                    
                    group.add(o);
                    group.add(h1);
                    group.add(h2);
                    group.add(createBond(o.position, h1.position));
                    group.add(createBond(o.position, h2.position));
                    
                    group.position.set((i - 1) * 5, 0, 0);
                    scene.add(group);
                    molecules.push(group);
                    
                    gsap.from(group.scale, {
                        duration: 1,
                        x: 0, y: 0, z: 0,
                        delay: i * 0.3,
                        ease: "back.out(1.7)"
                    });
                    
                    gsap.to(group.rotation, {
                        duration: 5,
                        y: Math.PI * 2,
                        repeat: -1,
                        ease: "none"
                    });
                }
            }
            
            // Demonstrate each postulate in sequence
            for (let i = 0; i < postulates.length; i++) {
                // Check if animation was stopped/interrupted
                if (!isAnimating || isTransitioning) {
                    break;
                }
                
                clearScene();
                daltonStage.style.display = 'block';
                document.getElementById('daltonTitle').textContent = `Postulate ${i + 1}: ${postulates[i].title}`;
                document.getElementById('daltonText').textContent = postulates[i].desc;
                
                // Update info display to show current postulate
                updateInfo(`Dalton's Postulate ${i + 1}`, postulates[i].desc);
                
                // Start animation first
                switch(i) {
                    case 0:
                        createMatterBreakdown();
                        break;
                    case 1:
                        createIndivisibleDemo();
                        break;
                    case 2:
                        createIdenticalAtomsDemo();
                        break;
                    case 3:
                        createDifferentElementsDemo();
                        break;
                    case 4:
                        await createRatioDemo();
                        break;
                    case 5:
                        createConstantCompositionDemo();
                        break;
                }
                
                // Check again before narration
                if (!isAnimating || isTransitioning) {
                    break;
                }
                
                // Start narration immediately after animation starts
                await narrator.speak(postulates[i].narration);
                
                // Check again before waiting
                if (!isAnimating || isTransitioning) {
                    break;
                }
                
                // Wait for narration to complete before next postulate
                await new Promise(resolve => {
                    const timeout = setTimeout(resolve, 1000);
                    currentTimeouts.push(timeout);
                });
            }
            
            // Only hide elements if animation wasn't interrupted
            if (isAnimating && !isTransitioning) {
                daltonStage.style.display = 'none';
                container.style.display = 'none';
            }
            
            // Reset animation flag
            isAnimating = false;
        }




        // Complete lesson
        async function playCompleteLesson() {
            // Stop any running animations first
            await stopAllAnimations();
            
            // Set flags
            isCompleteLessonRunning = true;
            isAnimating = true;
            
            // Show progress
            showProgress();
            updateProgressTitle("Complete Lesson: Law of Constant Proportions");
            
            try {
                // Step 1: Introduction
                updateProgress(1);
                await autoResetAndPrepare();
                await narrator.speak("Welcome to the Law of Constant Proportions! Let's explore how elements combine in fixed ratios to form compounds.");
                
                if (!isCompleteLessonRunning) return;
                
                // Step 2: Water demonstration
                updateProgress(2);
                await showWaterContent();
                await narrator.speak("Water always forms with hydrogen and oxygen in a 1 to 8 mass ratio. This is a perfect example of constant proportions.");
                await new Promise(resolve => {
                    currentTimeouts.push(setTimeout(resolve, 3000));
                });
                
                if (!isCompleteLessonRunning) return;
                
                // Step 3: Ammonia demonstration
                updateProgress(3);
                await narrator.speak("Now let's look at another compound - ammonia.");
                await showAmmoniaContent();
                await narrator.speak("Ammonia always has nitrogen and hydrogen in a 14 to 3 mass ratio. Notice how different compounds have different but consistent ratios.");
                await new Promise(resolve => {
                    currentTimeouts.push(setTimeout(resolve, 3000));
                });
                
                if (!isCompleteLessonRunning) return;
                
                // Step 4: Proportions demonstration
                updateProgress(4);
                await narrator.speak("The law of constant proportions states that a compound always contains the same elements in the same proportions by mass, regardless of its source.");
                await new Promise(resolve => {
                    currentTimeouts.push(setTimeout(resolve, 3000));
                });
                
                if (!isCompleteLessonRunning) return;
                
                // Step 5: Dalton's Theory
                updateProgress(5);
                await narrator.speak("To understand why this happens, let's explore Dalton's Atomic Theory, which provides the foundation for understanding chemical combinations.");
                await showDalton();
                
                if (!isCompleteLessonRunning) return;
                
                // Step 6: Conclusion
                updateProgress(6);
                await narrator.speak("This completes our lesson on the Law of Constant Proportions. We've seen how water and ammonia always form with fixed mass ratios, and learned how Dalton's Atomic Theory explains these consistent patterns in nature. Remember - compounds always have the same composition, no matter their source!");
                
                // Final reset
                await resetAll();
                updateInfo("Lesson Complete!", "Elements combine in fixed ratios - always!");
                
            } catch (error) {
                console.error("Error in complete lesson:", error);
            } finally {
                // Clean up
                isCompleteLessonRunning = false;
                isAnimating = false;
                hideProgress();
                setActiveButton(null);
            }
        }

        // Helper functions
        function updateInfo(title, text) {
            document.getElementById('infoTitle').textContent = title;
            document.getElementById('infoText').textContent = text;
        }

        function showRatio(items) {
            const display = document.getElementById('ratioDisplay');
            const content = document.getElementById('ratioContent');
            
            content.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'ratio-item';
                div.innerHTML = `
                    <span class="ratio-element">${item.element}:</span>
                    <span class="ratio-value">${item.value}</span>
                `;
                content.appendChild(div);
            });
            
            display.style.display = 'block';
        }

        function updateMassData(el1Name, el1Mass, el2Name, el2Mass, compName, compMass, ratio) {
            document.querySelector('#element1').parentElement.querySelector('.calc-label').textContent = el1Name;
            document.getElementById('element1').textContent = el1Mass;
            
            document.querySelector('#element2').parentElement.querySelector('.calc-label').textContent = el2Name;
            document.getElementById('element2').textContent = el2Mass;
            
            document.querySelector('#compound').parentElement.querySelector('.calc-label').textContent = compName;
            document.getElementById('compound').textContent = compMass;
            
            document.getElementById('ratio').textContent = ratio;
        }

        async function resetAll() {
            // Stop complete lesson if running
            if (isCompleteLessonRunning) {
                await stopCompleteLesson();
            }
            
            // Stop all animations first
            await stopAllAnimations();
            
            // Clear the scene
            clearScene();
            
            // Reset all UI elements
            document.getElementById('ratioDisplay').style.display = 'none';
            document.getElementById('postulatesContainer').style.display = 'none';
            document.getElementById('daltonStage').style.display = 'none';
            document.getElementById('atomLegend').style.display = 'none';
            hideProgress();
            
            // Reset mass data display
            updateMassData('Element 1', '-', 'Element 2', '-', 'Compound', '-', '-');
            
            // Reset info display
            updateInfo("Law of Constant Proportions", "Elements combine in fixed mass ratios");
            
            // Reset camera position
            if (camera) {
                gsap.set(camera.position, { x: 0, y: 5, z: 15 });
                camera.lookAt(0, 0, 0);
            }
            
            // Reset scene rotation
            if (scene) {
                gsap.set(scene.rotation, { x: 0, y: 0, z: 0 });
            }
            
            // Reset demo buttons
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.classList.remove('active', 'loading');
            });
            
            // Reset flags
            isCompleteLessonRunning = false;
            isAnimating = false;
            currentLessonStep = 0;
        }

        // Mouse controls
        function setupMouseControls() {
            const canvas = renderer.domElement;
            let isDragging = false;
            let previousMouse = { x: 0, y: 0 };
            
            canvas.addEventListener('mousedown', e => {
                isDragging = true;
                previousMouse = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mousemove', e => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - previousMouse.x;
                const deltaY = e.clientY - previousMouse.y;
                
                // Increased sensitivity from 0.02 to 0.04
                scene.rotation.y += deltaX * 0.04;
                scene.rotation.x += deltaY * 0.04;
                
                previousMouse = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('wheel', e => {
                e.preventDefault();
                // Increased sensitivity from 0.03 to 0.06
                camera.position.z += e.deltaY * 0.06;
                camera.position.z = Math.max(10, Math.min(30, camera.position.z));
            });
        }

        // Animation loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Rotate molecules
            molecules.forEach(mol => {
                mol.rotation.y += 0.01;
            });
            
            // Debug: Log scene children count
            if (scene.children.length > 3) { // More than just lights
                console.log(`Scene has ${scene.children.length} objects`);
            }
            
            renderer.render(scene, camera);
        }

        // Event listeners are now handled by onclick handlers in HTML

        // Audio controls
        document.getElementById('mute-btn').addEventListener('click', function() {
            narrator.isEnabled = !narrator.isEnabled;
            this.classList.toggle('muted');
            if (!narrator.isEnabled) narrator.stop();
        });

        const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
        let speedIndex = 2;
        document.getElementById('speed-btn').addEventListener('click', function() {
            speedIndex = (speedIndex + 1) % speeds.length;
            narrator.setSpeed(speeds[speedIndex]);
            this.textContent = speeds[speedIndex] + 'x';
        });

        // Handle resize
        window.addEventListener('resize', () => {
            const container = document.querySelector('.canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });


        // Enhanced initialization function
        function initialize() {
            init();
            
            // Ensure narrator is ready and start welcome message
            setTimeout(() => {
                if (narrator.isEnabled) {
                    narrator.speak("Welcome to the Law of Constant Proportions! Explore how elements combine in fixed ratios to form compounds.");
                }
            }, 1000);
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>